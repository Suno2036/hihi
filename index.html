<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ FemFit</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js for analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F0F4F8; /* Lighter background */
        }
        .main-container {
            max-width: 420px;
            height: 100vh;
            display: flex;
            flex-direction: column;
            border-left: 1px solid #e5e7eb;
            border-right: 1px solid #e5e7eb;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); /* Stronger shadow */
            border-radius: 12px; /* Rounded container */
            overflow: hidden; /* Ensures rounded corners clip content */
        }
        /* Hide scrollbar */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Accordion styles */
        details > summary {
            list-style: none;
        }
        details > summary::-webkit-details-marker {
            display: none;
        }
        details .arrow {
            transition: transform 0.2s ease-in-out;
        }
        details[open] .arrow {
            transform: rotate(90deg);
        }
        /* Message Box Styles */
        .message-box {
            position: fixed;
            bottom: 100px; /* Adjust as needed to be above the nav */
            left: 50%;
            transform: translateX(-50%);
            background-color: #4CAF50; /* Green */
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            z-index: 1000;
            opacity: 0;
            visibility: hidden; /* Added visibility for smoother transition */
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
            max-width: 90%;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        .message-box.show {
            opacity: 1;
            visibility: visible;
        }
        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6); /* Darker overlay */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .modal.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: white;
            padding: 24px;
            border-radius: 16px; /* More rounded */
            max-width: 380px;
            width: 90%;
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.3); /* Stronger shadow */
            position: relative;
            transform: translateY(20px); /* Slight animation on show */
            transition: transform 0.3s ease-out;
        }
        .modal.show .modal-content {
            transform: translateY(0);
        }
        .close-modal-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
            padding: 5px;
            border-radius: 50%;
            transition: background-color 0.2s;
        }
        .close-modal-btn:hover {
            background-color: #f0f0f0;
        }

        /* Loading Spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #8b5cf6; /* purple-500 */
            border-radius: 50%;
            width: 36px;
            height: 36px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-200 flex justify-center">

    <div id="app-container" class="bg-white main-container shadow-lg">
        <!-- Main Content Area -->
        <main class="flex-grow overflow-y-auto no-scrollbar p-6 pb-24">
            
            <!-- Home Screen -->
            <div id="home-screen">
                <header class="mb-8">
                    <h1 class="text-3xl font-bold text-gray-800">–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</h1>
                    <p class="text-gray-500">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–≥—Ä–∞–º–º—É –¥–ª—è –Ω–∞—á–∞–ª–∞</p>
                </header>
                <div class="space-y-3" id="workout-list">
                    <!-- Accordion will be injected here by JS -->
                </div>
            </div>

            <!-- Start Workout Confirmation Screen -->
            <div id="start-workout-screen" class="hidden flex flex-col items-center justify-center h-full text-center p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">–ù–∞—á–∞—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É?</h2>
                <p id="confirm-workout-title" class="text-xl text-purple-600 font-semibold mb-8"></p>
                <button id="start-workout-btn" class="bg-purple-600 text-white text-lg font-bold py-4 px-8 rounded-full shadow-lg hover:bg-purple-700 transition-transform active:scale-95">
                    –ù–∞—á–∞—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É
                </button>
                <button id="cancel-start-btn" class="mt-4 text-gray-500 hover:text-purple-600 font-medium">
                    –û—Ç–º–µ–Ω–∞
                </button>
            </div>

            <!-- Workout Screen -->
            <div id="workout-screen" class="hidden">
                 <!-- Button to go back to home screen without saving analytics -->
                 <button id="back-to-home" class="absolute top-4 left-4 text-gray-500 hover:text-purple-600 z-10 p-2 bg-white/50 rounded-full backdrop-blur-sm flex items-center gap-1 pr-3">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
                    <span class="text-sm font-medium">–ù–∞–∑–∞–¥</span>
                </button>
                <h2 id="workout-title" class="text-xl font-bold text-gray-800 mt-4 mb-2 px-4 text-center"></h2>
                
                <!-- Video Player -->
                <div id="video-container" class="bg-gray-900 rounded-2xl h-64 flex items-center justify-center my-4 overflow-hidden">
                    <!-- Iframe will be injected here -->
                </div>

                <!-- Play/Pause Button -->
                <div class="flex justify-center items-center gap-6 my-6">
                     <button id="play-pause-btn" class="p-6 bg-purple-600 rounded-full text-white shadow-lg hover:bg-purple-700 transition-transform active:scale-95">
                        <svg id="play-icon" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                        <svg id="pause-icon" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="currentColor" class="hidden"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>
                    </button>
                </div>
                <!-- New prominent End Workout button -->
                <div class="flex justify-center mt-8">
                    <button id="end-workout-main-btn" class="bg-red-500 text-white text-lg font-bold py-4 px-8 rounded-full shadow-lg hover:bg-red-600 transition-transform active:scale-95">
                        –ó–∞–≤–µ—Ä—à–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É
                    </button>
                </div>
            </div>

            <!-- Analytics Screen -->
            <div id="analytics-screen" class="hidden">
                 <header class="mb-8">
                    <h1 class="text-3xl font-bold text-gray-800">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</h1>
                    <p class="text-gray-500">–í–∞—à –ø—Ä–æ–≥—Ä–µ—Å—Å –≤ –º–∏–Ω—É—Ç–∞—Ö</p>
                </header>
                <div class="space-y-6">
                    <div class="grid grid-cols-2 gap-4 text-center">
                        <div class="bg-pink-100 p-4 rounded-xl">
                            <p class="text-sm text-pink-700">–¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</p>
                            <p id="stats-workouts" class="text-2xl font-bold text-pink-900">0</p>
                        </div>
                         <div class="bg-purple-100 p-4 rounded-xl">
                            <p class="text-sm text-purple-700">–í—Å–µ–≥–æ –º–∏–Ω—É—Ç</p>
                            <p id="stats-minutes" class="text-2xl font-bold text-purple-900">0</p>
                        </div>
                    </div>
                    <div>
                         <canvas id="progressChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Nutrition Screen -->
            <div id="nutrition-screen" class="hidden flex-col">
                <header class="mb-8">
                    <h1 class="text-3xl font-bold text-gray-800">–†–∞—Ü–∏–æ–Ω –ø–∏—Ç–∞–Ω–∏—è</h1>
                    <p class="text-gray-500">–í–∞—à –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π –ø–ª–∞–Ω –ø–∏—Ç–∞–Ω–∏—è</p>
                </header>

                <div class="mb-6">
                    <label for="nutrition-date-filter" class="block text-sm font-medium text-gray-700 mb-2">–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É:</label>
                    <input type="date" id="nutrition-date-filter" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500">
                </div>

                <!-- Daily Calorie Summary -->
                <div class="bg-purple-100 p-4 rounded-xl shadow-md mb-6 text-center">
                    <p class="text-sm text-purple-700">–í—Å–µ–≥–æ –∫–∞–ª–æ—Ä–∏–π –∑–∞ –¥–µ–Ω—å:</p>
                    <p id="daily-calories-total" class="text-2xl font-bold text-purple-900">0 –∫–∫–∞–ª</p>
                </div>

                <!-- Dietitian Recommendations Section -->
                <div class="bg-blue-50 p-4 rounded-xl shadow-md mb-6">
                    <h2 class="text-xl font-bold text-blue-800 mb-3">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–∏–µ—Ç–æ–ª–æ–≥–∞</h2>
                    <ul class="list-disc list-inside text-gray-700 space-y-2 text-sm">
                        <li>–¢–µ–º–ø —Å–Ω–∏–∂–µ–Ω–∏—è –≤–µ—Å–∞: –ø–ª–∞–≤–Ω–æ, 5-10% –∑–∞ 3-6 –º–µ—Å—è—Ü–µ–≤.</li>
                        <li>–û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∏–µ–º—ã –ø–∏—â–∏ (–∑–∞–≤—Ç—Ä–∞–∫, –æ–±–µ–¥, —É–∂–∏–Ω) –∏ 1-2 –ø–µ—Ä–µ–∫—É—Å–∞ –ø–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.</li>
                        <li>**–ü—Ä–∞–≤–∏–ª–æ —Ç–∞—Ä–µ–ª–∫–∏:**
                            <ul class="list-circle list-inside ml-4">
                                <li>1/4 —Ç–∞—Ä–µ–ª–∫–∏: –±–µ–ª–∫–∏ (–º—è—Å–æ, —Ä—ã–±–∞, –ø—Ç–∏—Ü–∞, —è–π—Ü–∞, —Ç–≤–æ—Ä–æ–≥, –≥—Ä–∏–±—ã).</li>
                                <li>1/4 —Ç–∞—Ä–µ–ª–∫–∏: —Å–ª–æ–∂–Ω—ã–µ —É–≥–ª–µ–≤–æ–¥—ã (–æ–≤—Å—è–Ω–∫–∞, –≥—Ä–µ—á–∫–∞, —Ä–∏—Å, –º–∞–∫–∞—Ä–æ–Ω—ã, –∫–∞—Ä—Ç–æ—Ñ–µ–ª—å).</li>
                                <li>1/2 —Ç–∞—Ä–µ–ª–∫–∏: –æ–≤–æ—â–∏ –∏ –∑–µ–ª–µ–Ω—å (–∫—Ä–æ–º–µ –∫–∞—Ä—Ç–æ—Ñ–µ–ª—è).</li>
                                <li>1 —Å—Ç. –ª–æ–∂–∫–∞ —Ä–∞—Å—Ç–∏—Ç–µ–ª—å–Ω–æ–≥–æ –º–∞—Å–ª–∞ (–æ–ª–∏–≤–∫–æ–≤–æ–µ, –ª—å–Ω—è–Ω–æ–µ).</li>
                            </ul>
                        </li>
                        <li>–ü–µ–π—Ç–µ 1.5-2 –ª–∏—Ç—Ä–∞ —á–∏—Å—Ç–æ–π –≤–æ–¥—ã –≤ –¥–µ–Ω—å.</li>
                        <li>–ò–∑–±–µ–≥–∞–π—Ç–µ —Å–ª–∞–¥–∫–∏—Ö –Ω–∞–ø–∏—Ç–∫–æ–≤ –∏ –¥–µ—Å–µ—Ä—Ç–æ–≤ (–¥–æ 10% –æ—Ç –∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç–∏).</li>
                        <li>–ü—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ–º—ã–µ —Å–ø–æ—Å–æ–±—ã –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è: –∑–∞–ø–µ–∫–∞–Ω–∏–µ, —Ç—É—à–µ–Ω–∏–µ, –Ω–∞ –ø–∞—Ä—É.</li>
                        <li>–ü–∏—Ç–∞–π—Ç–µ—Å—å –ø–æ —á—É–≤—Å—Ç–≤—É –≥–æ–ª–æ–¥–∞ –∏ —Å—ã—Ç–æ—Å—Ç–∏ (—à–∫–∞–ª–∞ 1-10).</li>
                        <li>–ò–Ω—Ç–µ—Ä–≤–∞–ª—ã –º–µ–∂–¥—É –ø—Ä–∏–µ–º–∞–º–∏ –ø–∏—â–∏: 3-5 —á–∞—Å–æ–≤.</li>
                        <li>–í–∫–ª—é—á–∏—Ç–µ —Ä–µ–≥—É–ª—è—Ä–Ω—É—é —Ñ–∏–∑–∏—á–µ—Å–∫—É—é –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å.</li>
                    </ul>
                </div>

                <div id="meal-list" class="space-y-4 mb-6 flex-grow overflow-y-auto no-scrollbar">
                    <!-- Meals will be injected here -->
                    <p id="no-meals-message" class="text-gray-500 text-center hidden pt-8">–ù–∞ —ç—Ç—É –¥–∞—Ç—É –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π –æ –ø–∏—Ç–∞–Ω–∏–∏.</p>
                </div>

                <!-- New button for Gemini API integration -->
                <button id="get-nutrition-recommendations-btn" class="w-full bg-gradient-to-r from-purple-500 to-indigo-500 text-white text-lg font-bold py-3 rounded-full shadow-lg hover:from-purple-600 hover:to-indigo-600 transition-all active:scale-95 mb-4">
                    ‚ú® –ê–Ω–∞–ª–∏–∑ —Ä–∞—Ü–∏–æ–Ω–∞ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
                </button>

                <!-- New button for meal plan from ingredients -->
                <button id="get-meal-plan-from-ingredients-btn" class="w-full bg-gradient-to-r from-blue-500 to-sky-500 text-white text-lg font-bold py-3 rounded-full shadow-lg hover:from-blue-600 hover:to-sky-600 transition-all active:scale-95 mb-4">
                    üçΩÔ∏è –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –ø–ª–∞–Ω –ø–∏—Ç–∞–Ω–∏—è –ø–æ –ø—Ä–æ–¥—É–∫—Ç–∞–º
                </button>

                <button id="add-meal-btn" class="w-full bg-gradient-to-r from-green-500 to-teal-500 text-white text-lg font-bold py-3 rounded-full shadow-lg hover:from-green-600 hover:to-teal-600 transition-all active:scale-95">
                    –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–µ–º –ø–∏—â–∏
                </button>
            </div>

        </main>

        <!-- Bottom Navigation -->
        <footer class="absolute bottom-0 left-0 right-0 w-full max-w-[420px] mx-auto bg-white/90 backdrop-blur-lg border-t border-gray-200 rounded-b-xl">
            <nav class="flex justify-around items-center p-2">
                <button data-screen="home-screen" class="nav-btn flex flex-col items-center text-purple-600 w-24 py-2 rounded-lg transition-colors hover:bg-gray-100">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="m9 12 2 2 4-4"/></svg>
                    <span class="text-xs font-medium">–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</span>
                </button>
                <button data-screen="analytics-screen" class="nav-btn flex flex-col items-center text-gray-500 hover:text-purple-600 w-24 py-2 rounded-lg transition-colors hover:bg-gray-100">
                   <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><path d="m19 9-5 5-4-4-3 3"/></svg>
                    <span class="text-xs font-medium">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</span>
                </button>
                <button data-screen="nutrition-screen" class="nav-btn flex flex-col items-center text-gray-500 hover:text-purple-600 w-24 py-2 rounded-lg transition-colors hover:bg-gray-100">
                    <!-- Fork and Knife Icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 7h.01"/><path d="M17 7h.01"/><path d="M17 3v4H3v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3h-4z"/></svg>
                    <span class="text-xs font-medium">–†–∞—Ü–∏–æ–Ω</span>
                </button>
            </nav>
        </footer>
        
        <!-- Custom Message Box -->
        <div id="message-box" class="message-box hidden">
            <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏" –Ω–∞ –≤–∏–¥–µ–æ–ø–ª–µ–µ—Ä–µ Rutube.</p>
        </div>

        <!-- Add Meal Modal -->
        <div id="add-meal-modal" class="modal hidden">
            <div class="modal-content">
                <button class="close-modal-btn" id="close-add-meal-modal">&times;</button>
                <h3 class="text-xl font-bold text-gray-800 mb-4">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–µ–º –ø–∏—â–∏</h3>
                <form id="add-meal-form" class="space-y-4">
                    <div>
                        <label for="meal-name" class="block text-sm font-medium text-gray-700">–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∏–µ–º–∞ –ø–∏—â–∏:</label>
                        <input type="text" id="meal-name" name="mealName" class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500" required>
                    </div>
                    <div>
                        <label for="meal-time" class="block text-sm font-medium text-gray-700">–í—Ä–µ–º—è:</label>
                        <input type="time" id="meal-time" name="mealTime" class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500" required>
                    </div>
                    <div>
                        <label for="meal-description" class="block text-sm font-medium text-gray-700">–û–ø–∏—Å–∞–Ω–∏–µ:</label>
                        <textarea id="meal-description" name="mealDescription" rows="3" class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500"></textarea>
                    </div>
                    <div class="flex justify-end space-x-4 mt-6">
                        <button type="button" id="cancel-add-meal" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors">–û—Ç–º–µ–Ω–∞</button>
                        <button type="submit" class="px-4 py-2 bg-gradient-to-r from-green-500 to-teal-500 text-white rounded-md hover:from-green-600 hover:to-teal-600 transition-colors">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Nutrition Recommendations Modal -->
        <div id="nutrition-recommendations-modal" class="modal hidden">
            <div class="modal-content">
                <button class="close-modal-btn" id="close-nutrition-recommendations-modal">&times;</button>
                <h3 class="text-xl font-bold text-gray-800 mb-4">–ê–Ω–∞–ª–∏–∑ —Ä–∞—Ü–∏–æ–Ω–∞ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</h3>
                <div id="recommendations-content" class="text-gray-700 space-y-3">
                    <div id="recommendations-loading" class="flex justify-center items-center py-8 hidden">
                        <div class="spinner"></div>
                        <p class="ml-4 text-gray-600">–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –≤–∞—à —Ä–∞—Ü–∏–æ–Ω...</p>
                    </div>
                    <p id="recommendations-overall-assessment" class="font-semibold text-lg"></p>
                    <p id="recommendations-macronutrients"></p>
                    <p id="recommendations-suggestion" class="italic text-sm"></p>
                    <p id="recommendations-error" class="text-red-600 hidden">–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.</p>
                </div>
                <div class="flex justify-end mt-6">
                    <button type="button" id="ok-nutrition-recommendations" class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition-colors">–û–ö</button>
                </div>
            </div>
        </div>

        <!-- Meal Plan From Ingredients Modal -->
        <div id="meal-plan-modal" class="modal hidden">
            <div class="modal-content">
                <button class="close-modal-btn" id="close-meal-plan-modal">&times;</button>
                <h3 class="text-xl font-bold text-gray-800 mb-4">–ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –ø–ª–∞–Ω –ø–∏—Ç–∞–Ω–∏—è</h3>
                <form id="meal-plan-form" class="space-y-4">
                    <div>
                        <label for="available-ingredients" class="block text-sm font-medium text-gray-700">–î–æ—Å—Ç—É–ø–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é):</label>
                        <textarea id="available-ingredients" name="availableIngredients" rows="4" class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –∫—É—Ä–∏—Ü–∞, —Ä–∏—Å, –±—Ä–æ–∫–∫–æ–ª–∏, —è–π—Ü–∞, –º–æ–ª–æ–∫–æ"></textarea>
                    </div>
                    <div class="flex justify-end space-x-4 mt-6">
                        <button type="button" id="cancel-meal-plan" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors">–û—Ç–º–µ–Ω–∞</button>
                        <button type="submit" id="submit-meal-plan" class="px-4 py-2 bg-gradient-to-r from-blue-500 to-sky-500 text-white rounded-md hover:from-blue-600 hover:to-sky-600 transition-colors">
                            –ü–æ–ª—É—á–∏—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
                        </button>
                    </div>
                </form>
                <div id="meal-plan-results" class="mt-6 space-y-4 hidden">
                    <div id="meal-plan-loading" class="flex justify-center items-center py-8 hidden">
                        <div class="spinner"></div>
                        <p class="ml-4 text-gray-600">–ì–µ–Ω–µ—Ä–∏—Ä—É—é –ø–ª–∞–Ω –ø–∏—Ç–∞–Ω–∏—è...</p>
                    </div>
                    <div id="meal-plan-display" class="space-y-4">
                        <!-- Meal plan suggestions will be inserted here -->
                    </div>
                    <p id="meal-plan-notes" class="text-sm text-gray-600 italic mt-4"></p>
                    <p id="meal-plan-error" class="text-red-600 hidden">–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø–ª–∞–Ω–∞ –ø–∏—Ç–∞–Ω–∏—è. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.</p>
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        // --- GLOBAL VARIABLES ---
        let chartInstance = null; // Defined globally for Chart.js instance

        // --- STATE MANAGEMENT ---
        const state = {
            currentScreen: 'home-screen',
            currentVideo: null,
            isTimerRunning: false,
            timerId: null,
            timeElapsed: 0, // in seconds
            analytics: JSON.parse(localStorage.getItem('femfitAnalytics')) || {
                workoutsCompleted: 0,
                totalSecondsTrained: 0,
                history: [0, 0, 0, 0, 0, 0, 0], // weekly history in seconds
                lastAnalyticsResetDate: new Date().toISOString().split('T')[0] // Store as YYYY-MM-DD
            },
            nutritionPlans: {}, // Object to store nutrition plans, keyed by date (YYYY-MM-DD)
            selectedNutritionDate: new Date().toISOString().split('T')[0], // Default to today
        };

        // --- DOM ELEMENTS (declared globally, assigned in DOMContentLoaded) ---
        let messageBox;
        let confirmWorkoutTitle; // For workout confirmation screen
        let workoutTitle; // For workout screen
        let videoContainer; // For workout screen
        let playIcon; // For play/pause button
        let pauseIcon; // For play/pause button

        // DOM elements for Nutrition
        let nutritionDateFilter;
        let mealListContainer;
        let noMealsMessage;
        let addMealModal;
        let addMealForm;
        let dailyCaloriesTotalElement; // New element for daily calorie total

        // New DOM elements for LLM recommendations
        let getNutritionRecommendationsBtn;
        let nutritionRecommendationsModal;
        let closeNutritionRecommendationsModalBtn;
        let okNutritionRecommendationsBtn;
        let recommendationsContent;
        let recommendationsLoading;
        let recommendationsOverallAssessment;
        let recommendationsMacronutrients;
        let recommendationsSuggestion;
        let recommendationsError;

        // New DOM elements for Meal Plan from Ingredients
        let getMealPlanFromIngredientsBtn;
        let mealPlanModal;
        let closeMealPlanModalBtn;
        let mealPlanForm;
        let availableIngredientsInput;
        let submitMealPlanBtn;
        let cancelMealPlanBtn;
        let mealPlanResults;
        let mealPlanLoading;
        let mealPlanDisplay;
        let mealPlanNotes;
        let mealPlanError;


        // --- DATA & CONFIG (can be global) ---
        const videoData = {
             "–®–ø–∞–≥–∞—Ç—ã": [
                { name: "–†–∞—Å—Ç—è–∂–∫–∞ –Ω–∞ –ø—Ä–æ–¥–æ–ª—å–Ω—ã–π —à–ø–∞–≥–∞—Ç | –î–ª—è –ª—é–±–æ–≥–æ —É—Ä–æ–≤–Ω—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ | 10 –º–∏–Ω—É—Ç", videoId: "cd63865a80342902b31a4053b22266a2" },
                { name: "–†–∞—Å—Ç—è–∂–∫–∞ –¥–ª—è –∑–∞–¥–Ω–µ–π –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏ –±–µ–¥—Ä–∞ | –†–∞—Å—Ç—è–∂–∫–∞ –Ω–æ–≥ –¥–ª—è —Å–∫–ª–∞–¥–∫–∏", videoId: "944d5f626929500d44de76dcd82299ba" },
                { name: "–†–∞—Å—Ç—è–∂–∫–∞ –Ω–∞ –ø–æ–ø–µ—Ä–µ—á–Ω—ã–π —à–ø–∞–≥–∞—Ç –¥–æ–º–∞ | –†–∞–±–æ—Ç–∞ –Ω–∞–¥ –¢–ë–° –∏ —ç–ª–∞—Å—Ç–∏—á–Ω–æ—Å—Ç—å—é –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏ –±–µ–¥—Ä–∞", videoId: "edc818d0a88a45ede658fe6ce5fd04c6" },
            ],
            "–ó–∞—Ä—è–¥–∫–∞": [
                { name: "–ó–∞—Ä—è–¥–∫–∞ —Å—Ç–æ—è 7 –º–∏–Ω—É—Ç | –£—Ç—Ä–µ–Ω–Ω–∏–π –∫–æ–º–ø–ª–µ–∫—Å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –±–µ–∑ —Å–ª–æ–≤", videoId: "b81384b5792804b968ebab41b8d5a07e" },
                { name: "–£—Ç—Ä–µ–Ω–Ω—è—è –∑–∞—Ä—è–¥–∫–∞ –Ω–∞ –≤—Å–µ —Ç–µ–ª–æ | –ö–æ–º–ø–ª–µ–∫—Å –Ω–∞ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å | 12 –º–∏–Ω—É—Ç", videoId: "a104625a76d394a9f29550c303f4d5a1" },
                { name: "–ó–∞—Ä—è–¥–∫–∞ —Å—Ç–æ—è | –£—Ç—Ä–µ–Ω–Ω—è—è —Ä–∞–∑–º–∏–Ω–∫–∞ –±–µ–∑ –∫–æ–≤—Ä–∏–∫–∞ | 5 –º–∏–Ω—É—Ç", videoId: "e65f896c051d2e646ee498dc84b59ef0" },
                { name: "–°–ø–æ–∫–æ–π–Ω–∞—è –∑–∞—Ä—è–¥–∫–∞ –¥–ª—è –∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ–≥–æ –ø—Ä–æ–±—É–∂–¥–µ–Ω–∏—è | –£—Ç—Ä–µ–Ω–Ω—è—è –∑–∞—Ä—è–¥–∫–∞ 10 –º–∏–Ω—É—Ç", videoId: "2ed335fa82902965222476d3efe49620" },
                { name: "–£—Ç—Ä–µ–Ω–Ω–∏–π –∫–æ–º–ø–ª–µ–∫—Å –æ—Ç –æ—Ç–µ–∫–æ–≤ | –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω—é—é –≤–æ–¥—Éüí¶", videoId: "139dc7f1499de4cf93d1f59e3da5e248" },
                { name: "–ú—è–≥–∫–∏–π –∫–æ–º–ø–ª–µ–∫—Å –¥–ª—è —Ç–µ–ª–∞ | –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –∫–æ–≥–¥–∞ –Ω–µ—Ç —Å–∏–ª", videoId: "e55b93e3f467cd983e7868f89f61d725" },
                { name: "–£—Ç—Ä–µ–Ω–Ω—è—è —Ä–∞–∑–º–∏–Ω–∫–∞ —Å—Ç–æ—è —É —Å—Ç–µ–Ω—ã | –ó–∞—Ä—è–¥–∫–∞ –±–µ–∑ –∫–æ–≤—Ä–∏–∫–∞ | 10 –º–∏–Ω—É—Ç", videoId: "4efb01dcbcdb961e629c6dbb0fe50e39" },
                { name: "–õ–∏–º—Ñ–æ–¥—Ä–µ–Ω–∞–∂–Ω–∞—è –∑–∞—Ä—è–¥–∫–∞ | –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –æ—Ç –æ—Ç–µ–∫–æ–≤ | 10 –º–∏–Ω—É—Ç", videoId: "6996625ee64d475a583e325538049bfb" },
                { name: "–ö–æ–º–ø–ª–µ–∫—Å –¥–ª—è –ø—Ä–∏—è—Ç–Ω–æ–≥–æ –ø—Ä–æ–±—É–∂–¥–µ–Ω–∏—è | –£—Ç—Ä–µ–Ω–Ω—è—è –∑–∞—Ä—è–¥–∫–∞ –¥–ª—è –≤—Å–µ–≥–æ —Ç–µ–ª–∞ 13 –º–∏–Ω—É—Ç", videoId: "0de0b79afd858f4458b7498470feb9f3" },
                { name: "–£—Ç—Ä–µ–Ω–Ω—è—è –∑–∞—Ä—è–¥–∫–∞ 20 –º–∏–Ω—É—Ç | –ó–∞—Ä—è–¥–∫–∞ —Å –ú–§–†-—Ä–æ–ª–ª–æ–º", videoId: "a7d727c5c468d6727046046308991547" },
                { name: "–£—Ç—Ä–µ–Ω–Ω—è—è –∑–∞—Ä—è–¥–∫–∞ | 20 –º–∏–Ω—É—Ç | —Å–ø–æ–∫–æ–π–Ω–∞—è —É—Ç—Ä–µ–Ω–Ω—è—è —Ä–∞–∑–º–∏–Ω–∫–∞", videoId: "dee53d636658f852f80e205bbd3faf6b" },
                { name: "–£—Ç—Ä–µ–Ω–Ω—è—è –∑–∞—Ä—è–¥–∫–∞ 7 –º–∏–Ω—É—Ç | –ü—Ä–∏—è—Ç–Ω–∞—è —Ä–∞—Å—Ç—è–∂–∫–∞ –Ω–∞ –≤—Å–µ —Ç–µ–ª–æ", videoId: "8907f968aa84c8ae8b481f2ea8329dcd" },
                { name: "–ó–∞—Ä—è–¥–∫–∞ –¥–ª—è —Ç–æ–Ω—É—Å–∞ –º—ã—à—Ü | –≠–Ω–µ—Ä–≥–∏—è –Ω–∞ —Ü–µ–ª—ã–π –¥–µ–Ω—å | –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ –∏ –ø–æ–¥—Ç—è–Ω—É—Ç–æ–≥–æ —Ç–µ–ª–∞", videoId: "d964ae0e6b161ae6f858177b0e933f34" },
                { name: "–ó–ê–†–Ø–î–ö–ê –°–¢–û–Ø | 7 –ú–ò–ù–£–¢ | –ë–ï–ó –ö–û–í–†–ò–ö–ê | –ø—Ä–æ—Å—Ç–∞—è —É—Ç—Ä–µ–Ω–Ω—è—è –∑–∞—Ä—è–¥–∫–∞", videoId: "23c02f0b7d998be89d331381081902b2" },
                { name: "–£—Ç—Ä–µ–Ω–Ω—è—è –∑–∞—Ä—è–¥–∫–∞ | morning workout | 10 min | no words, only music", videoId: "5a6f195ac8501a46f2ec35a70d564393" },
            ],
            "–ü–∏–ª–∞—Ç–µ—Å": [
                { name: "–ü–∏–ª–∞—Ç–µ—Å –Ω–∞ –≤—Å–µ —Ç–µ–ª–æ –¥–ª—è –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ —É—Ä–æ–≤–Ω—è | –ú—è–≥–∫–∞—è —Å–∏–ª–æ–≤–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –±–µ–∑ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –∫–æ–ª–µ–Ω–∏", videoId: "bb9547fc08b6159a18e208e6d1dd2e80" },
                { name: "–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏ –±–µ–¥—Ä–∞ | –ü–∏–ª–∞—Ç–µ—Å –¥–ª—è –ø–æ–¥—Ç—è–Ω—É—Ç—ã—Ö –±–µ–¥–µ—Ä", videoId: "73b50504d5cf18ab66e7c26a7e46fca6" },
                { name: "–ü–∏–ª–∞—Ç–µ—Å —Å –≥–∞–Ω—Ç–µ–ª—è–º–∏ –Ω–∞ –≤—Å–µ —Ç–µ–ª–æ | –î–æ–º–∞—à–Ω—è—è —Å–∏–ª–æ–≤–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞", videoId: "925f575ec5317b03d0ed8079f52e3060" },
                { name: "–ü–∏–ª–∞—Ç–µ—Å –Ω–∞ –≤—Å–µ —Ç–µ–ª–æ | –ö—Ä–∞—Å–∏–≤–∞—è –∏ –ø–æ–¥—Ç—è–Ω—É—Ç–∞—è —Ñ–∏–≥—É—Ä–∞ –≤ –¥–æ–º–∞—à–Ω–∏—Ö —É—Å–ª–æ–≤–∏—è—Ö | 40 –º–∏–Ω—É—Ç", videoId: "7b742d662f47ef775274f0aa663568fc" },
                { name: "–ü–∏–ª–∞—Ç–µ—Å –Ω–∞ –≤—Å–µ —Ç–µ–ª–æ —Å –º—è—á–æ–º | –ú—è–≥–∫–∞—è —Å–∏–ª–æ–≤–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ 20 –º–∏–Ω—É—Ç", videoId: "51135cb85375d0882bc5b107148c0db0" },
                { name: "–ü–∏–ª–∞—Ç–µ—Å –Ω–∞ –≤—Å–µ —Ç–µ–ª–æ | –ö—Ä–∞—Å–∏–≤–∞—è –∏ –∂–µ–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è —Ñ–∏–≥—É—Ä–∞ –∑–∞ 20 –º–∏–Ω—É—Ç", videoId: "377d02b7edc55df2964cf423be01edf4" },
                { name: "–ü–∏–ª–∞—Ç–µ—Å –Ω–∞ –≤—Å–µ —Ç–µ–ª–æ | –ó–∞–Ω—è—Ç–∏–µ –∏–∑ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –î–∂. –ü–∏–ª–∞—Ç–µ—Å–∞", videoId: "32230d4b5bac5fd95fce6c5ca0789775" },
                { name: "–ü–∏–ª–∞—Ç–µ—Å –Ω–∞ –≤—Å–µ —Ç–µ–ª–æ | –ú—è–≥–∫–∞—è —Å–∏–ª–æ–≤–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –¥–æ–º–∞ 10 –º–∏–Ω—É—Ç", videoId: "2e7ade6f1e83c09f2c9e332e2d4a623a" },
                { name: "–ü–∏–ª–∞—Ç–µ—Å –Ω–∞ –≤—Å–µ —Ç–µ–ª–æ | –ú—è–≥–∫–∞—è —Å–∏–ª–æ–≤–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –¥–æ–º–∞ 20 –º–∏–Ω—É—Ç", videoId: "bda9d85320b274e6c3f9d3a59274f953" },
                { name: "–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –≤ —Å—Ç–∏–ª–µ –ø–∏–ª–∞—Ç–µ—Å | –ü–∏–ª–∞—Ç–µ—Å –¥–ª—è —è–≥–æ–¥–∏—Ü –≤ –¥–æ–º–∞—à–Ω–∏—Ö —É—Å–ª–æ–≤–∏—è—Ö", videoId: "1f6344e707381c5742fec4727829c173" },
                { name: "–ü–∏–ª–∞—Ç–µ—Å –Ω–∞ –≤—Å–µ —Ç–µ–ª–æ | –ú—è–≥–∫–∞—è —Å–∏–ª–æ–≤–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –¥–æ–º–∞ 30 –º–∏–Ω—É—Ç", videoId: "5a9f0a52248440cb450f838f0c9b78de" },
                { name: "–ü–∏–ª–∞—Ç–µ—Å –¥–ª—è –∫–æ—Ä–∞ –∏ —è–≥–æ–¥–∏—Ü | –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –≤ –¥–æ–º–∞—à–Ω–∏—Ö —É—Å–ª–æ–≤–∏—è—Ö | –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –∏–∑ –ø–∏–ª–∞—Ç–µ—Å–∞", videoId: "d48775e92070136d5a68b228d9468b20" },
                { name: "–ü–∏–ª–∞—Ç–µ—Å –Ω–∞ –≤—Å–µ —Ç–µ–ª–æ | –°–ø–æ–∫–æ–π–Ω–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –≤ –¥–æ–º–∞—à–Ω–∏—Ö —É—Å–ª–æ–≤–∏—è—Ö| 20 –º–∏–Ω—É—Ç", videoId: "922f6985b0791112dbf23a765c2b2932" },
                { name: "–ü–∏–ª–∞—Ç–µ—Å –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–π –∏ –ø–æ–¥—Ç—è–Ω—É—Ç–æ–π —Ñ–∏–≥—É—Ä—ã | –ú—è–≥–∫–∞—è —Å–∏–ª–æ–≤–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –Ω–∞ –≤—Å–µ —Ç–µ–ª–æ", videoId: "13a059fbab5bb9ddb278ca2684d00b8a" },
                { name: "–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –ü–∏–ª–∞—Ç–µ—Å –¥–ª—è –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ —É—Ä–æ–≤–Ω—è | –†–∞–±–æ—Ç–∞ –Ω–∞–¥ –æ—Å–∞–Ω–∫–æ–π, –º—ã—à—Ü–∞–º–∏ –∫–æ—Ä–∞ –∏ –¥—ã—Ö–∞–Ω–∏–µ–º", videoId: "e587a4d593305ce268150ee755e521ce" },
                { name: "–ü–∏–ª–∞—Ç–µ—Å –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–π —Ñ–∏–≥—É—Ä—ã | –ü—Ä–∏—è—Ç–Ω–∞—è —Å–∏–ª–æ–≤–∞—è –Ω–∞ –≤—Å–µ —Ç–µ–ª–æ | 15 –º–∏–Ω—É—Ç", videoId: "59bbff17e58a0326cae80e2488769e95" },
                { name: "15 MIN PILATES WORKOUT | At-home Pilates (No Equipment, No Words)", videoId: "7a00de52f254bccd9b14cc9cdd40740c" },
            ],
            "–ó–¥–æ—Ä–æ–≤–∞—è —Å–ø–∏–Ω–∞": [
                { name: "–†–æ–≤–Ω–∞—è –æ—Å–∞–Ω–∫–∞ –∏ –∑–¥–æ—Ä–æ–≤–∞—è —Å–ø–∏–Ω–∞ | –£–±–µ—Ä–∏ —Å—É—Ç—É–ª–æ—Å—Ç—å –∏ –∑–∞–≤–µ—Ä–Ω—É—Ç—ã–µ –ø–ª–µ—á–∏", videoId: "64572be8d884226ff44a39f90b121a0f" },
                { name: "–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –¥–ª—è —à–µ–∏ –∏ –ø–ª–µ—á –∑–∞ —Ä–∞–±–æ—á–∏–º –º–µ—Å—Ç–æ–º | –£–±–µ—Ä–∏ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ –≤ —à–µ–µ –∏ —Å–ø–∏–Ω–µ –∑–∞ 5 –º–∏–Ω—É—Ç", videoId: "3d17a6e1e39caf9ea960d435949e94ff" },
                { name: "–£–±–∏—Ä–∞–µ–º —Ö–æ–ª–∫—É | –ö–æ–º–ø–ª–µ–∫—Å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –¥–ª—è —à–µ–π–Ω–æ-–≤–æ—Ä–æ—Ç–Ω–∏–∫–æ–≤–æ–π –∑–æ–Ω—ã", videoId: "9715a5a10b1a0e069c694340ddc47323" },
                { name: "–ó–¥–æ—Ä–æ–≤–∞—è –æ—Å–∞–Ω–∫–∞ | –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –¥–ª—è —Å–∏–ª—ã –∏ –≥–∏–±–∫–æ—Å—Ç–∏ —Å–ø–∏–Ω—ã", videoId: "b9db77232e9c35a4d128460db6d5bcca" },
                { name: "–†–∞—Å–∫—Ä—ã—Ç–∏–µ –≥—Ä—É–¥–Ω–æ–≥–æ –æ—Ç–¥–µ–ª–∞ –ø–æ–∑–≤–æ–Ω–æ—á–Ω–∏–∫–∞ | –ö—Ä–∞—Å–∏–≤–∞—è –æ—Å–∞–Ω–∫–∞ –∏ —Å–≤–æ–±–æ–¥–Ω–æ–µ –¥—ã—Ö–∞–Ω–∏–µ —Å –ú–§–†-—Ä–æ–ª–ª–æ–º", videoId: "4f1d3391ff74117f57f238672278ed84" },
                { name: "–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –æ—Ç –±–æ–ª–∏ –≤ –ø–æ—è—Å–Ω–∏—Ü–µ —Å –ú–§–†-—Ä–æ–ª–ª–æ–º | –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –¥–ª—è —Ä–∞—Å—Å–ª–∞–±–ª–µ–Ω–∏—è –ø–æ—è—Å–Ω–∏—Ü—ã", videoId: "f2f74d88ba070cc2cb1373498ae342de" },
                { name: "–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –¥–ª—è —Ç–æ–Ω—É—Å–∞ –º—ã—à—Ü —Å–ø–∏–Ω—ã –∏ –∫—Ä–∞—Å–∏–≤–æ–π –æ—Å–∞–Ω–∫–∏ | –£–∫—Ä–µ–ø–ª–µ–Ω–∏–µ –º—ã—à—Ü —Å–ø–∏–Ω—ã", videoId: "72195aa9d98c528a05f31c7f674266b4" },
                { name: "–ó–¥–æ—Ä–æ–≤–∞—è –∏ –∫—Ä–∞—Å–∏–≤–∞—è —Å–ø–∏–Ω–∞ –≤ –¥–æ–º–∞—à–Ω–∏—Ö —É—Å–ª–æ–≤–∏—è—Ö | –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –Ω–∞ –æ—Å–∞–Ω–∫—É", videoId: "5e80114bfae4c0d1fb48769108feec61" },
                { name: "–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–π –æ—Å–∞–Ω–∫–∏ | –†–∞–±–æ—Ç–∞ –Ω–∞–¥ —Ä–∞—Å–∫—Ä—ã—Ç–∏–µ–º –≥—Ä—É–¥–Ω–æ–≥–æ –æ—Ç–¥–µ–ª–∞ –ø–æ–∑–≤–æ–Ω–æ—á–Ω–∏–∫–∞", videoId: "78b46980553fbf2c7e47a140d9d56057" },
                { name: "–ö–æ–º–ø–ª–µ–∫—Å –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–π –∏ —Ä–æ–≤–Ω–æ–π –æ—Å–∞–Ω–∫–∏ | –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –¥–ª—è —Å–ø–∏–Ω—ã | 16 –º–∏–Ω—É—Ç", videoId: "1113e6db3ce7fd7ac8bcaa592164353f" },
            ],
            "–ù–æ–≥–∏ –∏ —è–≥–æ–¥–∏—Ü—ã": [
                { name: "–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏ –±–µ–¥—Ä–∞ | –ü–∏–ª–∞—Ç–µ—Å –¥–ª—è –ø–æ–¥—Ç—è–Ω—É—Ç—ã—Ö –±–µ–¥–µ—Ä", videoId: "73b50504d5cf18ab66e7c26a7e46fca6" },
                { name: "–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –¥–ª—è –ø–æ–¥—Ç—è–Ω—É—Ç—ã—Ö –±–µ–¥–µ—Ä | –¢–æ–Ω–∫–∏–µ –ª—è–∂–∫–∏ –≤ –¥–æ–º–∞—à–Ω–∏—Ö —É—Å–ª–æ–≤–∏—è—Ö", videoId: "497e77b589ed3177c016bedcd7ea907c" },
                { name: "–†–∞—Å—Ç—è–∂–∫–∞ –∏ –ú–§–† –±–µ–¥–µ—Ä –∏ —è–≥–æ–¥–∏—Ü | 20 –º–∏–Ω—É—Ç", videoId: "afd4638ccfe353023bccff01fed3b08e" },
                { name: "–ó–∞–Ω—è—Ç–∏–µ –æ—Ç —É—Å—Ç–∞–≤—à–∏—Ö –Ω–æ–≥ —Å –ú–§–†-—Ä–æ–ª–ª–æ–º | –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –æ—Ç –æ—Ç–µ—á–Ω–æ—Å—Ç–∏ –Ω–æ–≥", videoId: "a6393cdbeeebc71ddd28f37695256538" },
                { name: "–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –¥–ª—è —É–ø—Ä—É–≥–∏—Ö —è–≥–æ–¥–∏—Ü | –ù–æ–≤—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –¥–ª—è —Ç–æ–Ω—É—Å–∞ —è–≥–æ–¥–∏—Ü –≤ –¥–æ–º–∞—à–Ω–∏—Ö —É—Å–ª–æ–≤–∏—è—Ö", videoId: "82dcae87f89867f0bc6f9d289f185fe8" },
                { name: "–ú—è–≥–∫–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –¥–ª—è –ø–æ–¥—Ç—è–Ω—É—Ç—ã—Ö —è–≥–æ–¥–∏—Ü | –í –¥–æ–º–∞—à–Ω–∏—Ö —É—Å–ª–æ–≤–∏—è—Ö", videoId: "893259e70ca50bf58e84ec1cca1a549c" },
                { name: "–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –≤ —Å—Ç–∏–ª–µ –ø–∏–ª–∞—Ç–µ—Å | –ü–∏–ª–∞—Ç–µ—Å –¥–ª—è —è–≥–æ–¥–∏—Ü –≤ –¥–æ–º–∞—à–Ω–∏—Ö —É—Å–ª–æ–≤–∏—è—Ö", videoId: "1f6344e707381c5742fec4727829c173" },
                { name: "–ü–∏–ª–∞—Ç–µ—Å –¥–ª—è –∫–æ—Ä–∞ –∏ —è–≥–æ–¥–∏—Ü | –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –≤ –¥–æ–º–∞—à–Ω–∏—Ö —É—Å–ª–æ–≤–∏—è—Ö | –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –∏–∑ –ø–∏–ª–∞—Ç–µ—Å–∞", videoId: "d48775e92070136d5a68b228d9468b20" },
                { name: "–°–∏–ª–æ–≤–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –¥–ª—è –ø–æ–¥—Ç—è–Ω—É—Ç—ã—Ö –±–µ–¥–µ—Ä | 15 –º–∏–Ω—É—Ç –¥–ª—è –∫—Ä–∞—Å–∏–≤—ã—Ö –Ω–æ–∂–µ–∫", videoId: "13a5059c820b8dfee5c8c7e6f03f5921" },
            ],
            "HiiT –∏ –ö–∞—Ä–¥–∏–æ": [
                { name: "–ö–∞—Ä–¥–∏–æ –≤ –¥–æ–º–∞—à–Ω–∏—Ö —É—Å–ª–æ–≤–∏—è—Ö | HIIT —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –¥–ª—è –ø–æ—Ö—É–¥–µ–Ω–∏—è | 10 –º–∏–Ω—É—Ç", videoId: "ec4748b78d09b3bcb8950e4bf2ee74b4" },
                { name: "–ö–∞—Ä–¥–∏–æ—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —Å –∞–∫—Ü–µ–Ω—Ç–æ–º –Ω–∞ –ø—Ä–µ—Å—Å | HIIT —Å —É–ø–æ—Ä–æ–º –Ω–∞ –º—ã—à—Ü—ã –∫–æ—Ä–∞", videoId: "cff1a9f503fddfa9b61b0eec627d033d" },
                { name: "–í—ã—Å–æ–∫–æ–∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ | –∫–∞—Ä–¥–∏–æ –¥–æ–º–∞ | —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –¥–ª—è –ø–æ—Ö—É–¥–µ–Ω–∏—è", videoId: "e10028893097f23788bbda3b92d6ce37" },
            ],
            "–ú—ã—à—Ü—ã –ö–æ—Ä–∞ –∏ –ü—Ä–µ—Å—Å": [
                { name: "–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –æ—Ç –≤—ã–ø–∏—Ä–∞—é—â–µ–≥–æ –∂–∏–≤–æ—Ç–∞ | –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –Ω–∞ –≥–ª—É–±–æ–∫–∏–µ –º—ã—à—Ü—ã –∫–æ—Ä–∞", videoId: "2f89c8cccb4edb908426458d115df734" },
                { name: "–ü–æ–¥—Ç—è–Ω—É—Ç—ã–π –∂–∏–≤–æ—Ç | 10 –º–∏–Ω—É—Ç —Å —Ç–∞–π–º–µ—Ä–æ–º | –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –Ω–∞ –ø—Ä–µ—Å—Å", videoId: "2c43c41d90fba6715cdfda3ba059c64a" },
                { name: "–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –Ω–∞ –ø—Ä–µ—Å—Å –ø—Ä–∏ –¥–∏–∞—Å—Ç–∞–∑–µ | –£–±–∏—Ä–∞–µ–º –¥–∏–∞—Å—Ç–∞–∑", videoId: "f1df0099d524be65de03f33fc0c3d547" },
                { name: "–ö–∞—Ä–¥–∏–æ—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —Å –∞–∫—Ü–µ–Ω—Ç–æ–º –Ω–∞ –ø—Ä–µ—Å—Å | HIIT —Å —É–ø–æ—Ä–æ–º –Ω–∞ –º—ã—à—Ü—ã –∫–æ—Ä–∞", videoId: "cff1a9f503fddfa9b61b0eec627d033d" },
                { name: "–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –¥–ª—è –ø–ª–æ—Å–∫–æ–≥–æ –∂–∏–≤–æ—Ç–∏–∫–∞ | –ò–¥–µ–∞–ª—å–Ω–∞—è —Ç–∞–ª–∏—è –∏ —Ä–µ–ª—å–µ—Ñ–Ω—ã–π –∂–∏–≤–æ—Ç–∏–∫ –∑–∞ 20 –º–∏–Ω—É—Ç", videoId: "cd99b9eaf32962e0993bbf6baea4998a" },
                { name: "–†–µ–ª—å–µ—Ñ–Ω—ã–π –ø—Ä–µ—Å—Å | –ö—Ä–∞—Å–∏–≤—ã–π –∏ –ø–æ–¥—Ç—è–Ω—É—Ç—ã–π –∂–∏–≤–æ—Ç –∑–∞ 15 –º–∏–Ω—É—Ç –≤ –¥–µ–Ω—å", videoId: "dc3d003590214bfa3a60a05b785d4a1b" },
                { name: "–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –¥–ª—è –º—ã—à—Ü –∫–æ—Ä–∞ | –ö–æ–º–ø–ª–µ–∫—Å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –æ—Ç –≤—ã–ø–∏—Ä–∞—é—â–µ–≥–æ –∂–∏–≤–æ—Ç–∞", videoId: "9ecb46b1695a6219cad509b9a1ecdd2b" },
                { name: "–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –¥–ª—è –º—ã—à—Ü —Ç–∞–∑–æ–≤–æ–≥–æ –¥–Ω–∞ –∏ –∫–æ—Ä–∞ —Å –º—è—á–æ–º | –ö–æ–º–ø–ª–µ–∫—Å –¥–ª—è –ø–ª–æ—Å–∫–æ–≥–æ –∂–∏–≤–æ—Ç–∞", videoId: "6f5bafac20d8b8ca47ff1c872e4309fb" },
                { name: "–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –¥–ª—è –º—ã—à—Ü –∫–æ—Ä–∞ | –ó–∞–Ω—è—Ç–∏–µ –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ –∏ –ø–æ–¥—Ç—è–Ω—É—Ç–æ–≥–æ –∂–∏–≤–æ—Ç–∏–∫–∞", videoId: "9f26439b54d007a912a6e7a672a18f92" },
                { name: "–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –¥–ª—è –º—ã—à—Ü —Ç–∞–∑–æ–≤–æ–≥–æ –¥–Ω–∞ –∏ –∫–æ—Ä–∞ | –ü–æ–¥—Ç—è–≥–∏–≤–∞–µ–º –≤—ã–ø–∏—Ä–∞—é—â–∏–π –∂–∏–≤–æ—Ç–∏–∫", videoId: "5234961e5e7d2d512259850bf0f2a771" },
            ],
            "–í–µ—á–µ—Ä–Ω—è—è —Ä–∞—Å—Ç—è–∂–∫–∞": [
                { name: "–í–µ—á–µ—Ä–Ω—è—è —Ä–∞—Å—Ç—è–∂–∫–∞ –Ω–∞ –≤—Å–µ —Ç–µ–ª–æ | 20 –º–∏–Ω—É—Ç –¥–ª—è –≤–µ—á–µ—Ä–Ω–µ–≥–æ —Ä–∞—Å—Å–ª–∞–±–ª–µ–Ω–∏—è", videoId: "2275142171221124618791986420580c" },
                { name: "–†–∞—Å—Ç—è–∂–∫–∞ –±–µ–∑ —Å–ª–æ–≤ –≤ —Å–ø–æ–∫–æ–π–Ω–æ–º —Ç–µ–º–ø–µ | –†–∞—Å—Ç—è–∂–∫–∞ –Ω–∞ –≤—Å–µ —Ç–µ–ª–æ", videoId: "b166a152332990076296962269a6582e" },
                { name: "–°–ø–æ–∫–æ–π–Ω–∞—è –≤–µ—á–µ—Ä–Ω—è—è —Ä–∞—Å—Ç—è–∂–∫–∞ –ø–µ—Ä–µ–¥ —Å–Ω–æ–º | –†–∞—Å—Ç—è–∂–∫–∞ –¥–ª—è —Ä–∞—Å—Å–ª–∞–±–ª–µ–Ω–∏—è 10 –º–∏–Ω—É—Ç", videoId: "f2a7060a241277f215007421e19f2b2c" },
                { name: "–°–ø–æ–∫–æ–π–Ω–∞—è —Ä–∞—Å—Ç—è–∂–∫–∞ –Ω–∞ –≤—Å–µ —Ç–µ–ª–æ | 10 –º–∏–Ω—É—Ç", videoId: "d22957b11516281820610736e053f0f7" },
            ],
            "–†–∞—Å—Ç—è–∂–∫–∞": [
                { name: "–†–∞—Å—Ç—è–∂–∫–∞ –∏ –ú–§–† –±–µ–¥–µ—Ä –∏ —è–≥–æ–¥–∏—Ü | 20 –º–∏–Ω—É—Ç", videoId: "afd4638ccfe353023bccff01fed3b08e" },
                { name: "–†–∞—Å—Ç—è–∂–∫–∞ –Ω–∞ —Å–ø–∏–Ω—É | –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –¥–ª—è –≥–∏–±–∫–æ—Å—Ç–∏ —Å–ø–∏–Ω—ã", videoId: "ae9fbb4176e2d4874d90ca59c462f62c" },
                { name: "–¢–æ–Ω—É—Å –∏ –≥–∏–±–∫–æ—Å—Ç—å –º—ã—à—Ü –≤—Å–µ —Ç–µ–ª–∞ | –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è —Ä–∞—Å—Ç—è–∂–∫–∞ | —Å–∏–ª–∞ –∏ —Ä–∞—Å—Ç—è–∂–∫–∞", videoId: "5d660f38f7c0a003797e2b4987b10d66" },
                { name: "–†–∞—Å—Ç—è–∂–∫–∞ –Ω–∞ –ø—Ä–æ–¥–æ–ª—å–Ω—ã–π —à–ø–∞–≥–∞—Ç | –î–ª—è –ª—é–±–æ–≥–æ —É—Ä–æ–≤–Ω—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ | 10 –º–∏–Ω—É—Ç", videoId: "cd63865a80342902b31a4053b22266a2" },
                { name: "–†–∞—Å—Ç—è–∂–∫–∞ –Ω–∞ –≤—Å–µ —Ç–µ–ª–æ | –ö–æ—Ä–æ—Ç–∫–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –¥–ª—è –≥–∏–±–∫–æ—Å—Ç–∏ –≤—Å–µ–≥–æ —Ç–µ–ª–∞ | 10 –º–∏–Ω—É—Ç", videoId: "9fb396fe9a1aca1ae169d2e82336e75b" },
                { name: "–†–∞—Å—Ç—è–∂–∫–∞ –¥–ª—è –∑–∞–¥–Ω–µ–π –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏ –±–µ–¥—Ä–∞ | –†–∞—Å—Ç—è–∂–∫–∞ –Ω–æ–≥ –¥–ª—è —Å–∫–ª–∞–¥–∫–∏", videoId: "944d5f626929500d44de76dcd82299ba" },
                { name: "–†–∞—Å–∫—Ä—ã—Ç–∏–µ –≥—Ä—É–¥–Ω–æ–≥–æ –æ—Ç–¥–µ–ª–∞ –ø–æ–∑–≤–æ–Ω–æ—á–Ω–∏–∫–∞ | –ö—Ä–∞—Å–∏–≤–∞—è –æ—Å–∞–Ω–∫–∞ –∏ —Å–≤–æ–±–æ–¥–Ω–æ–µ –¥—ã—Ö–∞–Ω–∏–µ —Å –ú–§–†-—Ä–æ–ª–ª–æ–º", videoId: "4f1d3391ff74117f57f238672278ed84" },
                { name: "–†–∞—Å—Ç—è–∂–∫–∞ –±–µ–∑ —Å–ª–æ–≤ –≤ —Å–ø–æ–∫–æ–π–Ω–æ–º —Ç–µ–º–ø–µ | –†–∞—Å—Ç—è–∂–∫–∞ –Ω–∞ –≤—Å–µ —Ç–µ–ª–æ", videoId: "c47a95c7a1d511a56a423f03cb327d92" },
                { name: "–†–∞—Å—Ç—è–∂–∫–∞ –Ω–∞ –≤—Å–µ —Ç–µ–ª–æ | –ú—è–≥–∫–∞—è —Ä–∞—Å—Ç—è–∂–∫–∞ –≤ –¥–æ–º–∞—à–Ω–∏—Ö —É—Å–ª–æ–≤–∏—è—Ö", videoId: "3be1f6c78fecc3694d9a2e8c0735773d" },
                { name: "–£—Ç—Ä–µ–Ω–Ω—è—è –∑–∞—Ä—è–¥–∫–∞ 7 –º–∏–Ω—É—Ç | –ü—Ä–∏—è—Ç–Ω–∞—è —Ä–∞—Å—Ç—è–∂–∫–∞ –Ω–∞ –≤—Å–µ —Ç–µ–ª–æ", videoId: "8907f968aa84c8ae8b481f2ea8329dcd" },
                { name: "–†–∞—Å—Ç—è–∂–∫–∞ –∏ –ú–§–† –Ω–∞ –≤—Å–µ —Ç–µ–ª–æ | –°–ø–æ–∫–æ–π–Ω–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –¥–ª—è —Ä–∞—Å—Å–ª–∞–±–ª–µ–Ω–∏—è", videoId: "c28ea027c26f9c2c0635bd7167589f22" },
            ],
             "–ú—ã—à—Ü—ã –¢–∞–∑–æ–≤–æ–≥–æ –î–Ω–∞": [
                { name: "–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –¥–ª—è –º—ã—à—Ü —Ç–∞–∑–æ–≤–æ–≥–æ –¥–Ω–∞ | –ö–æ–º–ø–ª–µ–∫—Å –¥–ª—è –∂–µ–Ω—Å–∫–æ–≥–æ –∑–¥–æ—Ä–æ–≤—å—è 15 –º–∏–Ω—É—Ç", videoId: "865767b931081512168310023a102911" },
                { name: "–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –¥–ª—è –º—ã—à—Ü —Ç–∞–∑–æ–≤–æ–≥–æ –¥–Ω–∞ | –ó–∞–±–æ—Ç–∞ –æ –∂–µ–Ω—Å–∫–æ–º –∑–¥–æ—Ä–æ–≤—å–µ 20 –º–∏–Ω—É—Ç", videoId: "0122214300911712168310023a102911" },
            ]
        };
        const categoryColors = [
            'bg-rose-500', 'bg-fuchsia-500', 'bg-purple-500', 'bg-violet-500',
            'bg-indigo-500', 'bg-blue-500', 'bg-sky-500', 'bg-cyan-500', 'bg-teal-500',
            'bg-emerald-500', 'bg-green-500', 'bg-lime-500'
        ];

        // --- DEFAULT NUTRITION PLANS (Dietitian-approved examples) ---
        const defaultNutritionPlans = {
            "2025-07-30": [
                {
                    id: 'meal_def_1_20250730',
                    mealName: '–ó–∞–≤—Ç—Ä–∞–∫: –û–≤—Å—è–Ω–∫–∞ —Å —è–≥–æ–¥–∞–º–∏ –∏ –æ—Ä–µ—Ö–∞–º–∏',
                    mealTime: '08:00',
                    description: '–¶–µ–ª—å–Ω–æ–∑–µ—Ä–Ω–æ–≤–∞—è –æ–≤—Å—è–Ω–∫–∞ –Ω–∞ –≤–æ–¥–µ –∏–ª–∏ –Ω–µ–∂–∏—Ä–Ω–æ–º –º–æ–ª–æ–∫–µ, —Å–≤–µ–∂–∏–µ —è–≥–æ–¥—ã (–∫–ª—É–±–Ω–∏–∫–∞, —á–µ—Ä–Ω–∏–∫–∞), –≥–æ—Ä—Å—Ç—å –≥—Ä–µ—Ü–∫–∏—Ö –æ—Ä–µ—Ö–æ–≤. –ó–∞–ø—Ä–∞–≤–∫–∞: 1 —á.–ª. –ª—å–Ω—è–Ω–æ–≥–æ –º–∞—Å–ª–∞.',
                    calories: 350, // Added calories
                    components: {
                        protein: '–û—Ä–µ—Ö–∏ (–≥—Ä–µ—Ü–∫–∏–µ)',
                        carbs: '–û–≤—Å—è–Ω–∫–∞',
                        fats: '–õ—å–Ω—è–Ω–æ–µ –º–∞—Å–ª–æ',
                        vegetables: '–Ø–≥–æ–¥—ã'
                    }
                },
                {
                    id: 'meal_def_2_20250730',
                    mealName: '–û–±–µ–¥: –ö—É—Ä–∏–Ω–∞—è –≥—Ä—É–¥–∫–∞ —Å –æ–≤–æ—â–∞–º–∏ –∏ –±—É—Ä—ã–º —Ä–∏—Å–æ–º',
                    mealTime: '13:00',
                    description: '–ó–∞–ø–µ—á–µ–Ω–Ω–∞—è –∫—É—Ä–∏–Ω–∞—è –≥—Ä—É–¥–∫–∞, –±–æ–ª—å—à–∞—è –ø–æ—Ä—Ü–∏—è —Å–∞–ª–∞—Ç–∞ –∏–∑ —Å–≤–µ–∂–∏—Ö –æ–≤–æ—â–µ–π (–æ–≥—É—Ä—Ü—ã, –ø–æ–º–∏–¥–æ—Ä—ã, –∑–µ–ª–µ–Ω—å) —Å –æ–ª–∏–≤–∫–æ–≤—ã–º –º–∞—Å–ª–æ–º, 1/4 —Ç–∞—Ä–µ–ª–∫–∏ –±—É—Ä–æ–≥–æ —Ä–∏—Å–∞. –ü—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ: –∑–∞–ø–µ–∫–∞–Ω–∏–µ, —Å–≤–µ–∂–∏–µ.',
                    calories: 500, // Added calories
                    components: {
                        protein: '–ö—É—Ä–∏–Ω–∞—è –≥—Ä—É–¥–∫–∞',
                        carbs: '–ë—É—Ä—ã–π —Ä–∏—Å',
                        fats: '–û–ª–∏–≤–∫–æ–≤–æ–µ –º–∞—Å–ª–æ',
                        vegetables: '–û–≤–æ—â–Ω–æ–π —Å–∞–ª–∞—Ç'
                    }
                },
                {
                    id: 'meal_def_3_20250730',
                    mealName: '–ü–µ—Ä–µ–∫—É—Å: –Ø–±–ª–æ–∫–æ',
                    mealTime: '16:30',
                    description: '–û–¥–Ω–æ —Å–≤–µ–∂–µ–µ —è–±–ª–æ–∫–æ.',
                    calories: 95, // Added calories
                    components: {
                        protein: '',
                        carbs: '–Ø–±–ª–æ–∫–æ',
                        fats: '',
                        vegetables: ''
                    }
                },
                {
                    id: 'meal_def_4_20250730',
                    mealName: '–£–∂–∏–Ω: –ó–∞–ø–µ—á–µ–Ω–Ω–∞—è —Ä—ã–±–∞ —Å –±—Ä–æ–∫–∫–æ–ª–∏',
                    mealTime: '19:00',
                    description: '–§–∏–ª–µ –±–µ–ª–æ–π —Ä—ã–±—ã (—Ç—Ä–µ—Å–∫–∞/–º–∏–Ω—Ç–∞–π), –∑–∞–ø–µ—á–µ–Ω–Ω–æ–µ —Å –±—Ä–æ–∫–∫–æ–ª–∏. –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–µ–º–Ω–æ–≥–æ –ª–∏–º–æ–Ω–Ω–æ–≥–æ —Å–æ–∫–∞. –ü—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ: –∑–∞–ø–µ–∫–∞–Ω–∏–µ.',
                    calories: 300, // Added calories
                    components: {
                        protein: '–ë–µ–ª–∞—è —Ä—ã–±–∞',
                        carbs: '', // Low carb for dinner
                        fats: '–†—ã–±–∏–π –∂–∏—Ä (–µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ)',
                        vegetables: '–ë—Ä–æ–∫–∫–æ–ª–∏'
                    }
                }
            ],
            "2025-07-31": [
                {
                    id: 'meal_def_1_20250731',
                    mealName: '–ó–∞–≤—Ç—Ä–∞–∫: –û–º–ª–µ—Ç —Å –æ–≤–æ—â–∞–º–∏',
                    mealTime: '08:30',
                    description: '–û–º–ª–µ—Ç –∏–∑ 2 —è–∏—Ü —Å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º —à–ø–∏–Ω–∞—Ç–∞, –ø–æ–º–∏–¥–æ—Ä–æ–≤ –∏ –±–æ–ª–≥–∞—Ä—Å–∫–æ–≥–æ –ø–µ—Ä—Ü–∞. –ü–æ–¥–∞–µ—Ç—Å—è —Å –∫—É—Å–æ—á–∫–æ–º —Ü–µ–ª—å–Ω–æ–∑–µ—Ä–Ω–æ–≤–æ–≥–æ —Ö–ª–µ–±–∞. –ü—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ: –Ω–∞ –ø–∞—Ä—É –∏–ª–∏ –Ω–∞ —Å—É—Ö–æ–π —Å–∫–æ–≤–æ—Ä–æ–¥–µ.',
                    calories: 280, // Added calories
                    components: {
                        protein: '–Ø–π—Ü–∞',
                        carbs: '–¶–µ–ª—å–Ω–æ–∑–µ—Ä–Ω–æ–≤–æ–π —Ö–ª–µ–±',
                        fats: '–Ø–∏—á–Ω—ã–π –∂–µ–ª—Ç–æ–∫',
                        vegetables: '–®–ø–∏–Ω–∞—Ç, –ø–æ–º–∏–¥–æ—Ä—ã, –ø–µ—Ä–µ—Ü'
                    }
                },
                {
                    id: 'meal_def_2_20250731',
                    mealName: '–û–±–µ–¥: –°–∞–ª–∞—Ç —Å —Ç—É–Ω—Ü–æ–º –∏ –∫–∏–Ω–æ–∞',
                    mealTime: '13:30',
                    description: '–ë–æ–ª—å—à–æ–π —Å–∞–ª–∞—Ç –∏–∑ —Å–≤–µ–∂–∏—Ö –ª–∏—Å—Ç—å–µ–≤ —Å–∞–ª–∞—Ç–∞, –æ–≥—É—Ä—Ü–æ–≤, –ø–æ–º–∏–¥–æ—Ä–æ–≤, –∫–æ–Ω—Å–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ç—É–Ω—Ü–∞ –≤ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–º —Å–æ–∫—É, –æ—Ç–≤–∞—Ä–Ω–æ–π –∫–∏–Ω–æ–∞. –ó–∞–ø—Ä–∞–≤–∫–∞: –æ–ª–∏–≤–∫–æ–≤–æ–µ –º–∞—Å–ª–æ –∏ –ª–∏–º–æ–Ω–Ω—ã–π —Å–æ–∫. –ü—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ: —Å–≤–µ–∂–∏–µ, –æ—Ç–≤–∞—Ä–Ω—ã–µ.',
                    calories: 450, // Added calories
                    components: {
                        protein: '–¢—É–Ω–µ—Ü',
                        carbs: '–ö–∏–Ω–æ–∞',
                        fats: '–û–ª–∏–≤–∫–æ–≤–æ–µ –º–∞—Å–ª–æ',
                        vegetables: '–°–∞–ª–∞—Ç, –æ–≥—É—Ä—Ü—ã, –ø–æ–º–∏–¥–æ—Ä—ã'
                    }
                },
                {
                    id: 'meal_def_3_20250731',
                    mealName: '–ü–µ—Ä–µ–∫—É—Å: –ì–æ—Ä—Å—Ç—å –º–∏–Ω–¥–∞–ª—è',
                    mealTime: '17:00',
                    description: '–ù–µ–±–æ–ª—å—à–∞—è –≥–æ—Ä—Å—Ç—å —Å—ã—Ä–æ–≥–æ –º–∏–Ω–¥–∞–ª—è.',
                    calories: 160, // Added calories
                    components: {
                        protein: '–ú–∏–Ω–¥–∞–ª—å',
                        carbs: '',
                        fats: '–ú–∏–Ω–¥–∞–ª—å',
                        vegetables: ''
                    }
                },
                {
                    id: 'meal_def_4_20250731',
                    mealName: '–£–∂–∏–Ω: –¢–≤–æ—Ä–æ–≥ —Å —è–≥–æ–¥–∞–º–∏',
                    mealTime: '19:30',
                    description: '–ù–µ–∂–∏—Ä–Ω—ã–π —Ç–≤–æ—Ä–æ–≥ (5%) —Å –≥–æ—Ä—Å—Ç—å—é —Å–≤–µ–∂–∏—Ö –∏–ª–∏ –∑–∞–º–æ—Ä–æ–∂–µ–Ω–Ω—ã—Ö —è–≥–æ–¥. –ü—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ: —Å–≤–µ–∂–∏–µ.',
                    calories: 200, // Added calories
                    components: {
                        protein: '–¢–≤–æ—Ä–æ–≥',
                        carbs: '',
                        fats: '',
                        vegetables: '–Ø–≥–æ–¥—ã'
                    }
                }
            ]
        };


        // --- GLOBAL HELPER FUNCTIONS ---

        const showMessageBox = (message, isError = false) => {
            if (!messageBox) {
                console.error("MessageBox element not found. Cannot display message:", message);
                return;
            }
            messageBox.textContent = message;
            messageBox.classList.remove('hidden', 'bg-red-500', 'bg-green-500');
            if (isError) {
                messageBox.classList.add('bg-red-500');
            } else {
                messageBox.classList.add('bg-green-500');
            }
            messageBox.classList.add('show');
            messageBox.style.visibility = 'visible';
            setTimeout(() => {
                messageBox.classList.remove('show');
                messageBox.style.visibility = 'hidden';
            }, 3000);
        };

        // --- NUTRITION LOGIC FUNCTIONS (GLOBAL) ---

        // Loads nutrition plans from localStorage
        const loadNutritionPlansFromLocalStorage = () => {
            console.log("Nutrition Logic: Attempting to load nutrition plans from localStorage...");
            try {
                const nutritionJson = localStorage.getItem('femfitNutritionPlans');
                const loadedPlans = nutritionJson ? JSON.parse(nutritionJson) : null;

                if (!loadedPlans || Object.keys(loadedPlans).length === 0) {
                    // If no plans in localStorage or it's empty, use default plans
                    console.log("Nutrition Logic: No plans found in localStorage. Initializing with default plans.");
                    // Deep copy default plans to avoid modifying the constant
                    return JSON.parse(JSON.stringify(defaultNutritionPlans));
                }
                console.log("Nutrition Logic: Loaded nutrition plans from localStorage:", loadedPlans);
                return loadedPlans;
            } catch (e) {
                console.error("Nutrition Logic: Error loading nutrition plans from localStorage:", e);
                showMessageBox("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–ª–∞–Ω–æ–≤ –ø–∏—Ç–∞–Ω–∏—è –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞.", true);
                return JSON.parse(JSON.stringify(defaultNutritionPlans)); // Fallback to default on error
            }
        };

        // Saves nutrition plans to localStorage
        const saveNutritionPlansToLocalStorage = (plans) => {
            console.log("Nutrition Logic: Attempting to save nutrition plans to localStorage:", plans);
            try {
                localStorage.setItem('femfitNutritionPlans', JSON.stringify(plans));
                console.log("Nutrition Logic: Nutrition plans saved to localStorage successfully.");
            } catch (e) {
                console.error("Nutrition Logic: Error saving nutrition plans to localStorage:", e);
                showMessageBox("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–ª–∞–Ω–æ–≤ –ø–∏—Ç–∞–Ω–∏—è –≤ –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ.", true);
            }
        };

        const fetchNutritionPlans = () => {
            console.log("Nutrition Logic: fetchNutritionPlans called.");
            state.nutritionPlans = loadNutritionPlansFromLocalStorage();
            renderNutritionPlans(state.selectedNutritionDate);
        };

        const renderNutritionPlans = (dateString) => {
            console.log("Nutrition Logic: renderNutritionPlans called for date:", dateString);
            if (!mealListContainer || !noMealsMessage || !dailyCaloriesTotalElement) {
                console.error("Nutrition Logic: Meal DOM elements not found for rendering. Skipping render.");
                return;
            }
            mealListContainer.innerHTML = '';
            const mealsForDate = state.nutritionPlans[dateString] || [];
            const sortedMeals = mealsForDate.sort((a, b) => a.mealTime.localeCompare(b.mealTime));
            console.log("Nutrition Logic: Filtered meals for date", dateString, ":", sortedMeals);

            let dailyTotalCalories = 0;

            if (sortedMeals.length === 0) {
                noMealsMessage.classList.remove('hidden');
                console.log("Nutrition Logic: No meals found for this date. Displaying 'no meals' message.");
            } else {
                noMealsMessage.classList.add('hidden');
                sortedMeals.forEach(meal => {
                    const mealCard = document.createElement('div');
                    mealCard.className = "bg-white p-4 rounded-xl shadow-md flex justify-between items-center border border-gray-200";
                    
                    let componentsHtml = '';
                    if (meal.components) {
                        componentsHtml += '<div class="text-xs text-gray-500 mt-2">';
                        if (meal.components.protein) componentsHtml += `<p><strong>–ë–µ–ª–∫–∏:</strong> ${meal.components.protein}</p>`;
                        if (meal.components.carbs) componentsHtml += `<p><strong>–£–≥–ª–µ–≤–æ–¥—ã:</strong> ${meal.components.carbs}</p>`;
                        if (meal.components.fats) componentsHtml += `<p><strong>–ñ–∏—Ä—ã:</strong> ${meal.components.fats}</p>`;
                        if (meal.components.vegetables) componentsHtml += `<p><strong>–û–≤–æ—â–∏/–§—Ä—É–∫—Ç—ã:</strong> ${meal.components.vegetables}</p>`;
                        componentsHtml += '</div>';
                    }

                    const caloriesDisplay = meal.calories ? `<p class="text-sm font-semibold text-green-700 mt-1">${meal.calories} –∫–∫–∞–ª</p>` : '';
                    if (meal.calories) {
                        dailyTotalCalories += parseInt(meal.calories);
                    }

                    mealCard.innerHTML = `
                        <div>
                            <p class="font-bold text-gray-800 text-lg">${meal.mealName}</p>
                            <p class="text-sm text-gray-600">${meal.mealTime}</p>
                            ${caloriesDisplay}
                            ${meal.description ? `<p class="text-xs text-gray-500 mt-1 italic">${meal.description}</p>` : ''}
                            ${componentsHtml}
                        </div>
                        <button data-id="${meal.id}" data-date="${dateString}" class="delete-meal-btn text-red-500 hover:text-red-700 p-2 rounded-full bg-red-100 hover:bg-red-200 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                        </button>
                    `;
                    mealListContainer.appendChild(mealCard);
                });

                mealListContainer.querySelectorAll('.delete-meal-btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const mealIdToDelete = event.currentTarget.dataset.id;
                        const mealDate = event.currentTarget.dataset.date;
                        console.log("Nutrition Logic: Delete button clicked for meal ID:", mealIdToDelete, "on date:", mealDate);
                        deleteMeal(mealIdToDelete, mealDate);
                    });
                });
            }
            dailyCaloriesTotalElement.textContent = `${dailyTotalCalories} –∫–∫–∞–ª`;
        };

        // Function to call Gemini API for calorie estimation
        const getCaloriesFromGemini = async (mealName, mealDescription) => {
            const prompt = `–û—Ü–µ–Ω–∏ –ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω—É—é –∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç—å —Å–ª–µ–¥—É—é—â–µ–≥–æ –ø—Ä–∏–µ–º–∞ –ø–∏—â–∏. –£–∫–∞–∂–∏ —Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ –∫–∞–ª–æ—Ä–∏–π –≤ –∫–∫–∞–ª. –ï—Å–ª–∏ –Ω–µ –º–æ–∂–µ—à—å –æ—Ü–µ–Ω–∏—Ç—å, –≤–µ—Ä–Ω–∏ 0.
            –ù–∞–∑–≤–∞–Ω–∏–µ: ${mealName}
            –û–ø–∏—Å–∞–Ω–∏–µ: ${mealDescription || '–Ω–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è'}`;

            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });

            const payload = {
                contents: chatHistory,
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "calories": { "type": "NUMBER" }
                        },
                        "required": ["calories"]
                    }
                }
            };

            const apiKey = ""; // Leave as-is, Canvas will provide
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            let retryCount = 0;
            const maxRetries = 3;
            const baseDelay = 1000; // 1 second

            while (retryCount < maxRetries) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 && retryCount < maxRetries - 1) {
                            const delay = baseDelay * Math.pow(2, retryCount);
                            console.warn(`Rate limit exceeded for calorie estimation. Retrying in ${delay / 1000}s...`);
                            await new Promise(resolve => setTimeout(resolve, delay));
                            retryCount++;
                            continue;
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const jsonString = result.candidates[0].content.parts[0].text;
                        const parsedJson = JSON.parse(jsonString);
                        return parsedJson.calories || 0;
                    } else {
                        console.warn("Gemini API returned unexpected structure for calorie estimation.");
                        return 0;
                    }
                } catch (e) {
                    console.error("Error calling Gemini API for calorie estimation:", e);
                    return 0; // Return 0 on error
                }
            }
            return 0; // Fallback if all retries fail
        };


        const addMeal = async (mealData) => { // Made addMeal async
            console.log("Nutrition Logic: addMeal called with data:", mealData);
            const submitButton = addMealForm.querySelector('button[type="submit"]');
            const originalButtonText = submitButton.innerHTML; // Declare here
            try {
                // Show loading spinner in the modal while fetching calories
                submitButton.disabled = true;
                submitButton.innerHTML = '<div class="spinner w-5 h-5 border-2 mx-auto"></div>'; // Smaller spinner

                mealData.id = Date.now().toString(); // Simple unique ID
                console.log("Nutrition Logic: Assigned new meal ID:", mealData.id);
                
                // Call Gemini API to get calorie estimate
                mealData.calories = await getCaloriesFromGemini(mealData.mealName, mealData.mealDescription);
                console.log("Nutrition Logic: Calories estimated by Gemini:", mealData.calories);

                if (!state.nutritionPlans[state.selectedNutritionDate]) {
                    state.nutritionPlans[state.selectedNutritionDate] = [];
                }
                // For manually added meals, components might not be provided, so initialize them
                mealData.components = mealData.components || {}; 

                state.nutritionPlans[state.selectedNutritionDate].push(mealData);
                console.log("Nutrition Logic: state.nutritionPlans after push:", state.nutritionPlans);
                
                saveNutritionPlansToLocalStorage(state.nutritionPlans);
                showMessageBox("–ü—Ä–∏–µ–º –ø–∏—â–∏ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!");
                closeAddMealModal();
                renderNutritionPlans(state.selectedNutritionDate); // Re-render to show new meal
            } catch (e) {
                console.error("Nutrition Logic: Error adding meal:", e);
                showMessageBox("–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –ø—Ä–∏–µ–º–∞ –ø–∏—â–∏: " + e.message, true);
            } finally {
                // Restore submit button
                submitButton.disabled = false;
                submitButton.innerHTML = originalButtonText;
            }
        };

        const deleteMeal = (id, date) => {
            console.log("Nutrition Logic: deleteMeal called for ID:", id, "on date:", date);
            try {
                if (state.nutritionPlans[date]) {
                    const initialMealCount = state.nutritionPlans[date].length;
                    state.nutritionPlans[date] = state.nutritionPlans[date].filter(meal => meal.id !== id);
                    console.log("Nutrition Logic: state.nutritionPlans[date] after filter (deleted):", state.nutritionPlans[date]);
                    
                    if (state.nutritionPlans[date].length < initialMealCount) {
                        saveNutritionPlansToLocalStorage(state.nutritionPlans);
                        showMessageBox("–ü—Ä–∏–µ–º –ø–∏—â–∏ —É–¥–∞–ª–µ–Ω.");
                    } else {
                        showMessageBox("–ü—Ä–∏–µ–º –ø–∏—â–∏ —Å —Ç–∞–∫–∏–º ID –Ω–µ –Ω–∞–π–¥–µ–Ω.", true);
                    }
                } else {
                    showMessageBox("–ü–ª–∞–Ω –ø–∏—Ç–∞–Ω–∏—è –Ω–∞ —ç—Ç—É –¥–∞—Ç—É –Ω–µ –Ω–∞–π–¥–µ–Ω.", true);
                }
                renderNutritionPlans(state.selectedNutritionDate); // Re-render to reflect deletion
            } catch (e) {
                console.error("Nutrition Logic: Error deleting meal:", e);
                showMessageBox("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø—Ä–∏–µ–º–∞ –ø–∏—â–∏: " + e.message, true);
            }
        };

        const openAddMealModal = () => {
            console.log("Nutrition Logic: openAddMealModal called.");
            if (!addMealModal || !addMealForm || !document.getElementById('meal-time')) {
                console.error("Nutrition Logic: Modal DOM elements not found for opening. Skipping.");
                showMessageBox("–û—à–∏–±–∫–∞: –ù–µ –Ω–∞–π–¥–µ–Ω—ã —ç–ª–µ–º–µ–Ω—Ç—ã —Ñ–æ—Ä–º—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.", true);
                return;
            }
            console.log("Nutrition Logic: addMealModal current classes before showing:", addMealModal.classList.value);
            addMealModal.classList.add('show');
            addMealModal.classList.remove('hidden'); // Ensure hidden is removed
            console.log("Nutrition Logic: addMealModal classes after showing:", addMealModal.classList.value);

            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            document.getElementById('meal-time').value = `${hours}:${minutes}`;
            // No need to clear meal-calories input as it's removed
            console.log("Nutrition Logic: Add meal modal opened.");
        };

        const closeAddMealModal = () => {
            console.log("Nutrition Logic: closeAddMealModal called.");
            if (!addMealModal || !addMealForm) {
                console.error("Nutrition Logic: Modal DOM elements not found for closing. Skipping.");
                return;
            }
            addMealModal.classList.remove('show');
            addMealModal.classList.add('hidden'); // Add hidden back
            addMealForm.reset();
            console.log("Nutrition Logic: Add meal modal closed and form reset.");
        };

        // --- GEMINI API INTEGRATION FOR NUTRITION RECOMMENDATIONS ---

        const openNutritionRecommendationsModal = () => {
            nutritionRecommendationsModal.classList.add('show');
            nutritionRecommendationsModal.classList.remove('hidden');
            // Hide previous results and error, show loading
            recommendationsContent.classList.add('hidden');
            recommendationsLoading.classList.remove('hidden');
            recommendationsError.classList.add('hidden');
            recommendationsOverallAssessment.textContent = '';
            recommendationsMacronutrients.textContent = '';
            recommendationsSuggestion.textContent = '';
            
            callGeminiNutritionAPI();
        };

        const closeNutritionRecommendationsModal = () => {
            nutritionRecommendationsModal.classList.remove('show');
            nutritionRecommendationsModal.classList.add('hidden');
        };

        const callGeminiNutritionAPI = async () => {
            const mealsForDate = state.nutritionPlans[state.selectedNutritionDate] || [];
            if (mealsForDate.length === 0) {
                recommendationsLoading.classList.add('hidden');
                recommendationsError.classList.remove('hidden');
                recommendationsError.textContent = "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ø—Ä–∏–µ–º–∞—Ö –ø–∏—â–∏ –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.";
                recommendationsContent.classList.remove('hidden');
                return;
            }

            const formattedMeals = mealsForDate.map(meal => {
                return `–ù–∞–∑–≤–∞–Ω–∏–µ: ${meal.mealName}, –í—Ä–µ–º—è: ${meal.mealTime}, –ö–∞–ª–æ—Ä–∏–∏: ${meal.calories || '–Ω–µ —É–∫–∞–∑–∞–Ω–æ'}, –û–ø–∏—Å–∞–Ω–∏–µ: ${meal.description || '–Ω–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è'}`;
            }).join('\n');

            const prompt = `–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–ª–µ–¥—É—é—â–∏–π —Å–ø–∏—Å–æ–∫ –ø—Ä–∏–µ–º–æ–≤ –ø–∏—â–∏ –∑–∞ –¥–µ–Ω—å. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–∏–µ–º–∞ –ø–∏—â–∏ —É–∫–∞–∑–∞–Ω–æ: –Ω–∞–∑–≤–∞–Ω–∏–µ, –≤—Ä–µ–º—è, –∫–∞–ª–æ—Ä–∏–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å) –∏ –æ–ø–∏—Å–∞–Ω–∏–µ.

–ù–∞ –æ—Å–Ω–æ–≤–µ —ç—Ç–∏—Ö –¥–∞–Ω–Ω—ã—Ö:
1.  –î–∞–π –æ–±—â—É—é –æ—Ü–µ–Ω–∫—É —Ä–∞—Ü–∏–æ–Ω–∞ –Ω–∞ –¥–µ–Ω—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, '–•–æ—Ä–æ—à–∏–π –±–∞–ª–∞–Ω—Å', '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–µ–ª–∫–∞', '–ú–Ω–æ–≥–æ —É–≥–ª–µ–≤–æ–¥–æ–≤').
2.  –û—Ü–µ–Ω–∏ –ø—Ä–∏–º–µ—Ä–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–∞–∫—Ä–æ–Ω—É—Ç—Ä–∏–µ–Ω—Ç–æ–≤ –∑–∞ –¥–µ–Ω—å (–±–µ–ª–∫–∏, —É–≥–ª–µ–≤–æ–¥—ã, –∂–∏—Ä—ã) –≤ –æ–±—â–∏—Ö —á–µ—Ä—Ç–∞—Ö.
3.  –ü—Ä–µ–¥–ª–æ–∂–∏ –æ–¥–Ω—É –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é –ø–æ —É–ª—É—á—à–µ–Ω–∏—é —Ä–∞—Ü–∏–æ–Ω–∞ –∏–ª–∏ –∏–¥–µ—é –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–≥–æ –ø—Ä–∏–µ–º–∞ –ø–∏—â–∏, –µ—Å–ª–∏ –µ—Å—Ç—å —è–≤–Ω—ã–µ –ø—Ä–æ–±–µ–ª—ã.

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å JSON, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —Å–ª–µ–¥—É—é—â–µ–π —Å—Ö–µ–º–µ:
\`\`\`json
{
  "overallAssessment": "string",
  "macronutrientsSummary": {
    "protein": "string",
    "carbs": "string",
    "fats": "string"
  },
  "suggestion": "string"
}
\`\`\`

–ü—Ä–∏–µ–º—ã –ø–∏—â–∏:
${formattedMeals}`;

            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });

            const payload = {
                contents: chatHistory,
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "overallAssessment": { "type": "STRING" },
                            "macronutrientsSummary": {
                                "type": "OBJECT",
                                "properties": {
                                    "protein": { "type": "STRING" },
                                    "carbs": { "type": "STRING" },
                                    "fats": { "type": "STRING" }
                                }
                            },
                            "suggestion": { "type": "STRING" }
                        },
                        "required": ["overallAssessment", "macronutrientsSummary", "suggestion"]
                    }
                }
            };

            const apiKey = ""; // Leave as-is, Canvas will provide
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            let retryCount = 0;
            const maxRetries = 3;
            const baseDelay = 1000; // 1 second

            while (retryCount < maxRetries) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 && retryCount < maxRetries - 1) {
                            const delay = baseDelay * Math.pow(2, retryCount);
                            console.warn(`Rate limit exceeded. Retrying in ${delay / 1000}s...`);
                            await new Promise(resolve => setTimeout(resolve, delay));
                            retryCount++;
                            continue;
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const jsonString = result.candidates[0].content.parts[0].text;
                        const parsedJson = JSON.parse(jsonString);
                        
                        recommendationsOverallAssessment.textContent = `–û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞: ${parsedJson.overallAssessment}`;
                        recommendationsMacronutrients.textContent = `–ú–∞–∫—Ä–æ–Ω—É—Ç—Ä–∏–µ–Ω—Ç—ã: –ë–µ–ª–∫–∏ - ${parsedJson.macronutrientsSummary.protein}, –£–≥–ª–µ–≤–æ–¥—ã - ${parsedJson.macronutrientsSummary.carbs}, –ñ–∏—Ä—ã - ${parsedJson.macronutrientsSummary.fats}`;
                        recommendationsSuggestion.textContent = `–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: ${parsedJson.suggestion}`;
                        
                        recommendationsLoading.classList.add('hidden');
                        recommendationsContent.classList.remove('hidden');
                        recommendationsError.classList.add('hidden');
                        break; // Exit loop on success
                    } else {
                        throw new Error("–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞ –æ—Ç API Gemini.");
                    }
                } catch (e) {
                    console.error("Error calling Gemini API:", e);
                    recommendationsLoading.classList.add('hidden');
                    recommendationsError.classList.remove('hidden');
                    recommendationsError.textContent = `–û—à–∏–±–∫–∞: ${e.message}. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.`;
                    recommendationsContent.classList.remove('hidden');
                    break; // Exit loop on unrecoverable error
                }
            }
        };

        // --- NEW: GEMINI API INTEGRATION FOR MEAL PLAN FROM INGREDIENTS ---

        const openMealPlanModal = () => {
            mealPlanModal.classList.add('show');
            mealPlanModal.classList.remove('hidden');
            mealPlanForm.reset(); // Clear previous input
            mealPlanResults.classList.add('hidden'); // Hide results area initially
            mealPlanLoading.classList.add('hidden'); // Hide loading spinner
            mealPlanError.classList.add('hidden'); // Hide error message
            mealPlanDisplay.innerHTML = ''; // Clear previous suggestions
        };

        const closeMealPlanModal = () => {
            mealPlanModal.classList.remove('show');
            mealPlanModal.classList.add('hidden');
        };

        const getMealPlanFromGemini = async (ingredients) => {
            mealPlanResults.classList.remove('hidden'); // Show results area
            mealPlanLoading.classList.remove('hidden'); // Show loading spinner
            mealPlanError.classList.add('hidden'); // Hide any previous errors
            mealPlanDisplay.innerHTML = ''; // Clear previous suggestions

            const prompt = `–ü—Ä–µ–¥–ª–æ–∂–∏—Ç–µ –ø–ª–∞–Ω –ø–∏—Ç–∞–Ω–∏—è –Ω–∞ –æ–¥–∏–Ω –¥–µ–Ω—å (–ó–∞–≤—Ç—Ä–∞–∫, –û–±–µ–¥, –£–∂–∏–Ω), –∏—Å–ø–æ–ª—å–∑—É—è —Ç–æ–ª—å–∫–æ —Å–ª–µ–¥—É—é—â–∏–µ –ø—Ä–æ–¥—É–∫—Ç—ã: ${ingredients}.
            –î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–∏–µ–º–∞ –ø–∏—â–∏ —É–∫–∞–∂–∏—Ç–µ:
            - –¢–∏–ø –ø—Ä–∏–µ–º–∞ –ø–∏—â–∏ (–ó–∞–≤—Ç—Ä–∞–∫, –û–±–µ–¥, –£–∂–∏–Ω)
            - –ù–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞
            - –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è/—Å–æ—Å—Ç–∞–≤–∞
            - –ü—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω—É—é –∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç—å (—á–∏—Å–ª–æ –≤ –∫–∫–∞–ª). –ï—Å–ª–∏ –Ω–µ –º–æ–∂–µ—Ç–µ –æ—Ü–µ–Ω–∏—Ç—å, —É–∫–∞–∂–∏—Ç–µ 0.
            
            –í –∫–æ–Ω—Ü–µ –¥–æ–±–∞–≤—å—Ç–µ –∫–æ—Ä–æ—Ç–∫—É—é –æ–±—â—É—é –∑–∞–º–µ—Ç–∫—É –æ –ø–ª–∞–Ω–µ.

            –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å JSON, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —Å–ª–µ–¥—É—é—â–µ–π —Å—Ö–µ–º–µ:
            \`\`\`json
            {
              "mealPlan": [
                {
                  "type": "string",
                  "name": "string",
                  "description": "string",
                  "calories": "number"
                }
              ],
              "notes": "string"
            }
            \`\`\`
            `;

            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });

            const payload = {
                contents: chatHistory,
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "mealPlan": {
                                "type": "ARRAY",
                                "items": {
                                    "type": "OBJECT",
                                    "properties": {
                                        "type": { "type": "STRING" },
                                        "name": { "type": "STRING" },
                                        "description": { "type": "STRING" },
                                        "calories": { "type": "NUMBER" }
                                    },
                                    "required": ["type", "name", "description", "calories"]
                                }
                            },
                            "notes": { "type": "STRING" }
                        },
                        "required": ["mealPlan", "notes"]
                    }
                }
            };

            const apiKey = ""; // Leave as-is, Canvas will provide
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            let retryCount = 0;
            const maxRetries = 3;
            const baseDelay = 1000; // 1 second

            try {
                while (retryCount < maxRetries) {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 && retryCount < maxRetries - 1) {
                            const delay = baseDelay * Math.pow(2, retryCount);
                            console.warn(`Rate limit exceeded for meal plan generation. Retrying in ${delay / 1000}s...`);
                            await new Promise(resolve => setTimeout(resolve, delay));
                            retryCount++;
                            continue;
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const jsonString = result.candidates[0].content.parts[0].text;
                        const parsedJson = JSON.parse(jsonString);
                        
                        mealPlanDisplay.innerHTML = ''; // Clear before adding new results
                        parsedJson.mealPlan.forEach(meal => {
                            const mealElement = document.createElement('div');
                            mealElement.className = "bg-blue-50 p-3 rounded-lg shadow-sm border border-blue-100";
                            mealElement.innerHTML = `
                                <p class="font-bold text-blue-800 text-md">${meal.type}: ${meal.name}</p>
                                <p class="text-sm text-gray-700">${meal.description}</p>
                                <p class="text-xs text-blue-600 font-semibold">${meal.calories} –∫–∫–∞–ª</p>
                            `;
                            mealPlanDisplay.appendChild(mealElement);
                        });
                        mealPlanNotes.textContent = `–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: ${parsedJson.notes}`;
                        
                        mealPlanLoading.classList.add('hidden');
                        mealPlanError.classList.add('hidden');
                        mealPlanResults.classList.remove('hidden'); // Ensure results are visible
                        break; // Exit loop on success
                    } else {
                        throw new Error("–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞ –æ—Ç API Gemini.");
                    }
                }
            } catch (e) {
                console.error("Error calling Gemini API for meal plan:", e);
                mealPlanLoading.classList.add('hidden');
                mealPlanError.classList.remove('hidden');
                mealPlanError.textContent = `–û—à–∏–±–∫–∞: ${e.message}. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.`;
            } finally {
                submitMealPlanBtn.disabled = false;
                submitMealPlanBtn.innerHTML = '–ü–æ–ª—É—á–∏—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è';
            }
        };


        // --- DOMContentLoaded EVENT LISTENER ---
        document.addEventListener('DOMContentLoaded', async () => {
            // --- ASSIGN DOM ELEMENTS ---
            // Changed screens object to use full IDs as keys
            const screens = {
                'home-screen': document.getElementById('home-screen'),
                'start-workout-screen': document.getElementById('start-workout-screen'), 
                'workout-screen': document.getElementById('workout-screen'),
                'analytics-screen': document.getElementById('analytics-screen'),
                'nutrition-screen': document.getElementById('nutrition-screen'), 
            };
            const navButtons = document.querySelectorAll('.nav-btn');
            const workoutListContainer = document.getElementById('workout-list');
            
            const backToHomeButton = document.getElementById('back-to-home'); 
            const endWorkoutMainButton = document.getElementById('end-workout-main-btn');
            
            workoutTitle = document.getElementById('workout-title'); // Global assignment
            videoContainer = document.getElementById('video-container'); // Global assignment
            const playPauseBtn = document.getElementById('play-pause-btn');
            playIcon = document.getElementById('play-icon'); // Global assignment
            pauseIcon = document.getElementById('pause-icon'); // Global assignment
            messageBox = document.getElementById('message-box'); // Global assignment

            confirmWorkoutTitle = document.getElementById('confirm-workout-title'); // Global assignment
            const startWorkoutBtn = document.getElementById('start-workout-btn');
            const cancelStartBtn = document.getElementById('cancel-start-btn');

            // Assign DOM elements for Nutrition
            nutritionDateFilter = document.getElementById('nutrition-date-filter');
            mealListContainer = document.getElementById('meal-list');
            noMealsMessage = document.getElementById('no-meals-message');
            const addMealBtn = document.getElementById('add-meal-btn');
            addMealModal = document.getElementById('add-meal-modal');
            addMealForm = document.getElementById('add-meal-form');
            const cancelAddMealBtn = document.getElementById('cancel-add-meal');
            const closeAddMealModalBtn = document.getElementById('close-add-meal-modal');
            dailyCaloriesTotalElement = document.getElementById('daily-calories-total'); // Assign new element

            // Assign new DOM elements for LLM recommendations
            getNutritionRecommendationsBtn = document.getElementById('get-nutrition-recommendations-btn');
            nutritionRecommendationsModal = document.getElementById('nutrition-recommendations-modal');
            closeNutritionRecommendationsModalBtn = document.getElementById('close-nutrition-recommendations-modal');
            okNutritionRecommendationsBtn = document.getElementById('ok-nutrition-recommendations');
            recommendationsContent = document.getElementById('recommendations-content');
            recommendationsLoading = document.getElementById('recommendations-loading');
            recommendationsOverallAssessment = document.getElementById('recommendations-overall-assessment');
            recommendationsMacronutrients = document.getElementById('recommendations-macronutrients');
            recommendationsSuggestion = document.getElementById('recommendations-suggestion');
            recommendationsError = document.getElementById('recommendations-error');

            // Assign new DOM elements for Meal Plan from Ingredients
            getMealPlanFromIngredientsBtn = document.getElementById('get-meal-plan-from-ingredients-btn');
            mealPlanModal = document.getElementById('meal-plan-modal');
            closeMealPlanModalBtn = document.getElementById('close-meal-plan-modal');
            mealPlanForm = document.getElementById('meal-plan-form');
            availableIngredientsInput = document.getElementById('available-ingredients');
            submitMealPlanBtn = document.getElementById('submit-meal-plan');
            cancelMealPlanBtn = document.getElementById('cancel-meal-plan');
            mealPlanResults = document.getElementById('meal-plan-results');
            mealPlanLoading = document.getElementById('meal-plan-loading');
            mealPlanDisplay = document.getElementById('meal-plan-display');
            mealPlanNotes = document.getElementById('meal-plan-notes');
            mealPlanError = document.getElementById('meal-plan-error');


            // --- UI RENDERING FUNCTIONS (LOCAL TO DOMContentLoaded) ---
            const switchScreen = (screenId) => {
                state.currentScreen = screenId;
                // Iterate over the screens object to hide all screens
                for (const id in screens) {
                    const screenElement = screens[id]; // Get the actual DOM element
                    if (screenElement) { 
                        screenElement.classList.add('hidden');
                        screenElement.classList.remove('flex'); // Remove flex in case it was added
                    }
                }
                
                // Get the target screen element directly from the screens object
                const targetScreenElement = screens[screenId];

                if (targetScreenElement) {
                    // Check if the screen should be displayed with flex
                    if (['start-workout-screen', 'nutrition-screen'].includes(screenId)) {
                        targetScreenElement.classList.remove('hidden');
                        targetScreenElement.classList.add('flex');
                    } else {
                        targetScreenElement.classList.remove('hidden');
                    }
                } else {
                    console.error(`Error: Target screen element for ID '${screenId}' not found.`);
                    // Optionally, show a user-friendly message or default to home screen
                    showMessageBox("–û—à–∏–±–∫–∞: –≠–∫—Ä–∞–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.", true);
                    return; // Stop execution if target screen is not found
                }
                
                navButtons.forEach(btn => {
                    btn.classList.remove('text-purple-600', 'font-bold');
                    btn.classList.add('text-gray-500', 'hover:text-purple-600');
                    if (btn.dataset.screen === screenId) {
                        btn.classList.add('text-purple-600', 'font-bold');
                        btn.classList.remove('text-gray-500', 'hover:text-purple-600');
                    }
                });

                if (screenId === 'analytics-screen') {
                    renderAnalytics();
                } else if (screenId === 'nutrition-screen') {
                    console.log("Nutrition Logic: Switching to nutrition screen.");
                    nutritionDateFilter.value = state.selectedNutritionDate;
                    fetchNutritionPlans(); // Load and render nutrition plans for the new date
                }
            };

            const renderWorkoutList = () => {
                workoutListContainer.innerHTML = '';
                let colorIndex = 0;
                for (const category in videoData) {
                    const color = categoryColors[colorIndex % categoryColors.length];
                    colorIndex++;

                    const details = document.createElement('details');
                    details.className = "group";

                    const summary = document.createElement('summary');
                    summary.className = `${color} text-white p-4 rounded-lg flex justify-between items-center cursor-pointer transition hover:opacity-90 shadow-md`;
                    summary.innerHTML = `
                        <span class="font-bold">${category}</span>
                        <svg class="arrow w-6 h-6 transition-transform transform group-open:rotate-90" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" /></svg>
                    `;
                    
                    const videoGrid = document.createElement('div');
                    videoGrid.className = "mt-2 space-y-2 pl-2";

                    videoData[category].forEach(video => {
                        const element = document.createElement('div');
                        element.className = "bg-gray-100 p-3 rounded-lg flex items-center gap-3 cursor-pointer hover:bg-purple-100 transition-colors shadow-sm";
                        element.onclick = () => showStartWorkoutConfirmation(video); 
                        
                        element.innerHTML = `
                            <div class="text-purple-500">
                               <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M10 16.5v-9l6 4.5-6 4.5zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/></svg>
                            </div>
                            <p class="font-semibold text-gray-800 text-sm">${video.name}</p>
                        `;
                        videoGrid.appendChild(element);
                    });
                    
                    details.appendChild(summary);
                    details.appendChild(videoGrid);
                    workoutListContainer.appendChild(details);
                }
            };
            
            const renderAnalytics = () => {
                document.getElementById('stats-workouts').textContent = state.analytics.workoutsCompleted;
                document.getElementById('stats-minutes').textContent = Math.floor(state.analytics.totalSecondsTrained / 60);
                renderChart();
            };

            const renderChart = () => {
                const ctx = document.getElementById('progressChart').getContext('2d');
                if (chartInstance) chartInstance.destroy();
                
                const minutesHistory = state.analytics.history.map(seconds => Math.floor(seconds / 60));

                chartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['–ù–µ–¥–µ–ª—è -6', '–ù–µ–¥–µ–ª—è -5', '–ù–µ–¥–µ–ª—è -4', '–ù–µ–¥–µ–ª—è -3', '–ù–µ–¥–µ–ª—è -2', '–ü—Ä–æ—à–ª–∞—è –Ω–µ–¥–µ–ª—è', '–¢–µ–∫—É—â–∞—è –Ω–µ–¥–µ–ª—è'],
                        datasets: [{
                            label: '–ú–∏–Ω—É—Ç —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫',
                            data: minutesHistory,
                            backgroundColor: 'rgba(168, 85, 247, 0.8)',
                            borderColor: 'rgb(168, 85, 247)',
                            borderWidth: 1,
                            borderRadius: 8,
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { 
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.dataset.label + ': ' + context.parsed.y + ' –º–∏–Ω';
                                    }
                                }
                            }
                        },
                        scales: { 
                            y: { 
                                beginAtZero: true, 
                                ticks: { color: '#6b7280' },
                                grid: { color: '#e5e7eb' }
                            }, 
                            x: { 
                                ticks: { color: '#6b7280' },
                                grid: { display: false }
                            } 
                        }
                    }
                });
            };

            // --- WORKOUT LOGIC FUNCTIONS (LOCAL TO DOMContentLoaded) ---
            const showStartWorkoutConfirmation = (video) => {
                state.currentVideo = video;
                confirmWorkoutTitle.textContent = video.name;
                switchScreen('start-workout-screen');
            };

            const confirmStartWorkout = () => {
                workoutTitle.textContent = state.currentVideo.name;
                
                videoContainer.innerHTML = `<iframe id="video-player" src="https://rutube.ru/play/embed/${state.currentVideo.videoId}" frameborder="0" allow="fullscreen; picture-in-picture" webkitallowfullscreen mozallowfullscreen allowfullscreen class="w-full h-full rounded-2xl"></iframe>`;
                
                resetTimer();
                togglePlayPause();
                switchScreen('workout-screen');
                showMessageBox("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø—É—Å—Ç–∏—Ç–µ –≤–∏–¥–µ–æ –≤—Ä—É—á–Ω—É—é –Ω–∞ –ø–ª–µ–µ—Ä–µ Rutube. –¢–∞–π–º–µ—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–∞—á–∞–ª –æ—Ç—Å—á–µ—Ç.");
            };

            const togglePlayPause = () => {
                state.isTimerRunning = !state.isTimerRunning;
                if (state.isTimerRunning) {
                    playIcon.classList.add('hidden');
                    pauseIcon.classList.remove('hidden');
                    state.timerId = setInterval(updateTimer, 1000);
                } else {
                    playIcon.classList.remove('hidden');
                    pauseIcon.classList.add('hidden');
                    clearInterval(state.timerId);
                    showMessageBox("–¢–∞–π–º–µ—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.");
                }
            };
            
            const endWorkoutAndSave = () => {
                if(state.isTimerRunning) {
                    togglePlayPause();
                }
                logAnalytics();
                videoContainer.innerHTML = '';
                switchScreen('home-screen');
            };

            const resetTimer = () => {
                clearInterval(state.timerId);
                state.isTimerRunning = false;
                state.timeElapsed = 0;
                playIcon.classList.remove('hidden');
                pauseIcon.classList.add('hidden');
            };

            const updateTimer = () => {
                state.timeElapsed++;
            };
            
            const logAnalytics = () => {
                if (state.timeElapsed > 0) {
                    state.analytics.workoutsCompleted++;
                    state.analytics.totalSecondsTrained += state.timeElapsed;
                    state.analytics.history[6] += state.timeElapsed;
                    saveAnalytics();
                }
            };
            
            const saveAnalytics = () => {
                localStorage.setItem('femfitAnalytics', JSON.stringify(state.analytics));
            };

            const checkAndResetWeeklyAnalytics = () => {
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                let lastResetDate = new Date(state.analytics.lastAnalyticsResetDate);
                lastResetDate.setHours(0, 0, 0, 0);

                const currentWeekStart = new Date(today);
                currentWeekStart.setDate(today.getDate() - (today.getDay() + 6) % 7);
                currentWeekStart.setHours(0, 0, 0, 0);

                const lastRecordedWeekStart = new Date(lastResetDate);
                lastRecordedWeekStart.setDate(lastResetDate.getDate() - (lastResetDate.getDay() + 6) % 7);
                lastRecordedWeekStart.setHours(0, 0, 0, 0);

                if (currentWeekStart.getTime() > lastRecordedWeekStart.getTime()) {
                    state.analytics.history.shift();
                    state.analytics.history.push(0);
                    state.analytics.lastAnalyticsResetDate = today.toISOString().split('T')[0];
                    saveAnalytics();
                    console.log("Analytics history reset for a new week.");
                }
            };

            // --- EVENT LISTENERS ---
            navButtons.forEach(btn => {
                btn.addEventListener('click', () => switchScreen(btn.dataset.screen));
            });
            backToHomeButton.addEventListener('click', () => {
                if(state.isTimerRunning) {
                    togglePlayPause();
                }
                videoContainer.innerHTML = '';
                switchScreen('home-screen');
            });
            endWorkoutMainButton.addEventListener('click', endWorkoutAndSave);
            playPauseBtn.addEventListener('click', togglePlayPause);
            startWorkoutBtn.addEventListener('click', confirmStartWorkout);
            cancelStartBtn.addEventListener('click', () => switchScreen('home-screen'));

            // Event listeners for Nutrition
            addMealBtn.addEventListener('click', () => {
                console.log("Nutrition Logic: Add Meal Button clicked.");
                openAddMealModal();
            });
            cancelAddMealBtn.addEventListener('click', closeAddMealModal);
            closeAddMealModalBtn.addEventListener('click', closeAddMealModal);
            addMealForm.addEventListener('submit', async (event) => { // Made event listener async
                event.preventDefault();
                console.log("Nutrition Logic: Add meal form submitted.");
                const formData = new FormData(addMealForm);
                const mealData = {};
                for (let [key, value] of formData.entries()) {
                    mealData[key] = value;
                }
                await addMeal(mealData); // Await the addMeal function
            });

            nutritionDateFilter.addEventListener('change', (event) => {
                state.selectedNutritionDate = event.target.value;
                fetchNutritionPlans(); // Re-fetch and render for the new date
            });

            // Event listeners for LLM recommendations
            getNutritionRecommendationsBtn.addEventListener('click', openNutritionRecommendationsModal);
            closeNutritionRecommendationsModalBtn.addEventListener('click', closeNutritionRecommendationsModal);
            okNutritionRecommendationsBtn.addEventListener('click', closeNutritionRecommendationsModal);

            // New event listeners for Meal Plan from Ingredients
            getMealPlanFromIngredientsBtn.addEventListener('click', openMealPlanModal);
            closeMealPlanModalBtn.addEventListener('click', closeMealPlanModal);
            cancelMealPlanBtn.addEventListener('click', closeMealPlanModal);
            mealPlanForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                const ingredients = availableIngredientsInput.value.trim();
                if (ingredients) {
                    submitMealPlanBtn.disabled = true;
                    submitMealPlanBtn.innerHTML = '<div class="spinner w-5 h-5 border-2 mx-auto"></div>'; // Smaller spinner
                    await getMealPlanFromGemini(ingredients);
                } else {
                    showMessageBox("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã.", true);
                }
            });


            // --- INITIALIZATION ON DOMContentLoaded ---
            renderWorkoutList();
            checkAndResetWeeklyAnalytics();
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            state.selectedNutritionDate = `${year}-${month}-${day}`; // Initialize nutrition date
            nutritionDateFilter.value = state.selectedNutritionDate;

            fetchNutritionPlans(); // Initial load of nutrition plans
            switchScreen('home-screen');
        });
    </script>
</body>
</html>
